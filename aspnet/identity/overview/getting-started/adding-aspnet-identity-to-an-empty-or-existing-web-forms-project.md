---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: 加入 ASP.NET Identity 至空的或現有的 Web Form 專案 |Microsoft 文件
author: raquelsa
description: 本教學課程會示範如何將 ASP.NET Identity （新的成員資格系統適用於 ASP.NET） 加入至 ASP.NET 應用程式。 當您建立新的 Web Form 或 MVC...
ms.author: aspnetcontent
manager: wpickett
ms.date: 10/23/2013
ms.topic: article
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: 8961e596f0d6cc4810e2439be1ec2915bddb8c78
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/06/2018
ms.locfileid: "30874651"
---
<a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="db7ce-104">加入 ASP.NET Identity 至空的或現有的 Web Form 專案</span><span class="sxs-lookup"><span data-stu-id="db7ce-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>
====================
<span data-ttu-id="db7ce-105">由[Raquel Soares De Almeida](https://github.com/raquelsa)</span><span class="sxs-lookup"><span data-stu-id="db7ce-105">by [Raquel Soares De Almeida](https://github.com/raquelsa)</span></span>

> <span data-ttu-id="db7ce-106">本教學課程會示範如何加入[ASP.NET Identity](introduction-to-aspnet-identity.md) （新的成員資格系統適用於 ASP.NET） 的 ASP.NET 應用程式。</span><span class="sxs-lookup"><span data-stu-id="db7ce-106">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="db7ce-107">當您建立新的 Web Form 或 MVC 專案在 Visual Studio 2013 RTM 與個別帳戶時，Visual Studio 會安裝所有必要的封裝，並為您新增所有必要的類別。</span><span class="sxs-lookup"><span data-stu-id="db7ce-107">When you create a new Web Forms or MVC project in Visual Studio 2013 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="db7ce-108">本教學課程將說明如何將 ASP.NET 識別身分支援加入至現有的 Web Form 專案或新的空白專案。</span><span class="sxs-lookup"><span data-stu-id="db7ce-108">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="db7ce-109">我會列出所有安裝，您需要的 NuGet 封裝和您要新增的類別。</span><span class="sxs-lookup"><span data-stu-id="db7ce-109">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="db7ce-110">我將介紹範例 Web Form 註冊新的使用者和登入時反白顯示所有的主要進入點 Api，管理使用者和驗證。</span><span class="sxs-lookup"><span data-stu-id="db7ce-110">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="db7ce-111">這個範例將使用 SQL 資料存放區為基礎的 Entity Framework 所建立的 ASP.NET Identity 的預設實作。</span><span class="sxs-lookup"><span data-stu-id="db7ce-111">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="db7ce-112">本教學課程中，我們將使用 LocalDB 的 SQL 資料庫。</span><span class="sxs-lookup"><span data-stu-id="db7ce-112">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 
> <span data-ttu-id="db7ce-113">本教學課程中所編寫的 Raquel Soares De Almeida 和 Rick Anderson ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) )。</span><span class="sxs-lookup"><span data-stu-id="db7ce-113">This tutorial was written by Raquel Soares De Almeida and Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ).</span></span>


## <a name="getting-started-aspnet-identity"></a><span data-ttu-id="db7ce-114">開始使用 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="db7ce-114">Getting Started ASP.NET Identity</span></span>

1. <span data-ttu-id="db7ce-115">開始安裝並執行[Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058)或[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)。</span><span class="sxs-lookup"><span data-stu-id="db7ce-115">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span>
2. <span data-ttu-id="db7ce-116">按一下**新專案**從開始頁面上，或者您可以使用功能表，然後選取**檔案**，然後**新專案**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-116">Click **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="db7ce-117">選取**Visual C# i** n 的左窗格，然後**Web** ，然後選取  **ASP.NET Web 應用程式**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-117">Select **Visual C# i** n the left pane, then **Web** and then select **ASP.NET Web Application**.</span></span> <span data-ttu-id="db7ce-118">將您的專案"WebFormsIdentity"，再按一下**確定**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-118">Name your project "WebFormsIdentity" and then click **OK**.</span></span>   
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image1.png)
4. <span data-ttu-id="db7ce-119">在**新增 ASP.NET 專案**對話方塊中，選取**空**範本。</span><span class="sxs-lookup"><span data-stu-id="db7ce-119">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="db7ce-120">請注意**變更驗證**按鈕已停用，並提供此範本中沒有驗證支援。</span><span class="sxs-lookup"><span data-stu-id="db7ce-120">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="db7ce-121">Web Form、 MVC 和 Web API 範本可讓您選取驗證方法。</span><span class="sxs-lookup"><span data-stu-id="db7ce-121">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span> <span data-ttu-id="db7ce-122">如需詳細資訊，請參閱[概觀的驗證](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth)。</span><span class="sxs-lookup"><span data-stu-id="db7ce-122">For more information, see [Overview of Authentication](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth) .</span></span>

## <a name="adding-identity-packages-to-your-app"></a><span data-ttu-id="db7ce-123">識別封裝加入您的應用程式</span><span class="sxs-lookup"><span data-stu-id="db7ce-123">Adding Identity Packages to your App</span></span>

<span data-ttu-id="db7ce-124">在 [方案總管] 中，以滑鼠右鍵按一下您的專案，然後選取**管理 NuGet 封裝**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-124">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="db7ce-125">在 搜尋文字 方塊 對話方塊中，輸入 「*Identity.E*"。</span><span class="sxs-lookup"><span data-stu-id="db7ce-125">In the search text box dialog, type "*Identity.E*".</span></span> <span data-ttu-id="db7ce-126">按一下 安裝此套件。</span><span class="sxs-lookup"><span data-stu-id="db7ce-126">Click install for this package.</span></span>   
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image3.png)  
  
<span data-ttu-id="db7ce-127">請注意，此套件會安裝相依性套件： EntityFramework 和 Microsoft ASP.NET Identity Core。</span><span class="sxs-lookup"><span data-stu-id="db7ce-127">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span>

## <a name="adding-web-forms-to-register-users"></a><span data-ttu-id="db7ce-128">若要註冊的使用者加入的 Web Form</span><span class="sxs-lookup"><span data-stu-id="db7ce-128">Adding Web Forms to Register Users</span></span>

1. <span data-ttu-id="db7ce-129">在**方案總管 中**，以滑鼠右鍵按一下您的專案，然後按一下**新增**，然後**Web Form**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-129">In **Solution Explorer**, right-click your project and click **Add**, and then **Web Form**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="db7ce-130">在**指定項目的名稱**對話方塊中，命名新的 web form**註冊**，然後按一下  **確定**</span><span class="sxs-lookup"><span data-stu-id="db7ce-130">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then click **OK**</span></span>
3. <span data-ttu-id="db7ce-131">取代所產生的標記*Register.aspx*下列程式碼檔案。</span><span class="sxs-lookup"><span data-stu-id="db7ce-131">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="db7ce-132">程式碼變更已醒目提示。</span><span class="sxs-lookup"><span data-stu-id="db7ce-132">The code changes are highlighted.</span></span>   

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="db7ce-133">這是只的簡化的版*Register.aspx*當您建立新的 ASP.NET Web Form 專案時所建立的檔案。</span><span class="sxs-lookup"><span data-stu-id="db7ce-133">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="db7ce-134">上述的標記將表單欄位並註冊新的使用者 按鈕。</span><span class="sxs-lookup"><span data-stu-id="db7ce-134">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="db7ce-135">開啟*Register.aspx.cs*檔案，然後以下列程式碼取代檔案的內容：</span><span class="sxs-lookup"><span data-stu-id="db7ce-135">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="db7ce-136">上述程式碼為概要*Register.aspx.cs*當您建立新的 ASP.NET Web Form 專案時所建立的檔案。</span><span class="sxs-lookup"><span data-stu-id="db7ce-136">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="db7ce-137">*IdentityUser*類別是預設 EntityFramework 實作*IUser*介面。</span><span class="sxs-lookup"><span data-stu-id="db7ce-137">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="db7ce-138">*IUser*介面是基本的 ASP.NET Identity Core 上的使用者介面。</span><span class="sxs-lookup"><span data-stu-id="db7ce-138">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="db7ce-139">*UserStore*類別是使用者存放區的預設 EntityFramework 實作。</span><span class="sxs-lookup"><span data-stu-id="db7ce-139">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="db7ce-140">這個類別會實作 ASP.NET Identity Core 最少的介面： *IUserStore*， *IUserLoginStore*， *IUserClaimStore*和*IUserRoleStore*.</span><span class="sxs-lookup"><span data-stu-id="db7ce-140">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="db7ce-141">*UserManager*類別公開使用者相關的 Api，其會自動儲存的變更*UserStore*。</span><span class="sxs-lookup"><span data-stu-id="db7ce-141">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="db7ce-142">*IdentityResult*類別表示識別作業的結果。</span><span class="sxs-lookup"><span data-stu-id="db7ce-142">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="db7ce-143">在**方案總管 中**，以滑鼠右鍵按一下您的專案，然後按一下**新增**，**加入 ASP.NET 資料夾**然後**應用程式\_資料**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-143">In **Solution Explorer**, right-click your project and click **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="db7ce-144">開啟*Web.config*檔案，並加入我們將用來儲存使用者資訊之資料庫的連接字串項目。</span><span class="sxs-lookup"><span data-stu-id="db7ce-144">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="db7ce-145">將會建立此資料庫在執行階段由 EntityFramework 識別實體。</span><span class="sxs-lookup"><span data-stu-id="db7ce-145">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="db7ce-146">當您建立新的 Web Form 專案時，為您建立的其中一個相似的連接字串。</span><span class="sxs-lookup"><span data-stu-id="db7ce-146">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="db7ce-147">反白顯示的程式碼示範標記，您應該將新增：</span><span class="sxs-lookup"><span data-stu-id="db7ce-147">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="db7ce-148">Visual Studio 2015 或更高版本，取代`(localdb)\v11.0`與`(localdb)\MSSQLLocalDB`連接字串中。</span><span class="sxs-lookup"><span data-stu-id="db7ce-148">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="db7ce-149">以滑鼠右鍵按一下檔案*Register.aspx*在您的專案並選取**設定為起始頁**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-149">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="db7ce-150">按 Ctrl + F5 以建置並執行 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="db7ce-150">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="db7ce-151">輸入新的使用者名稱和密碼，然後按一下 上**註冊**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-151">Enter a new user name and password and then click on **Register**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="db7ce-152">ASP.NET 識別進行驗證的支援，與在此範例中，您可以驗證使用者名稱和密碼的預設行為是來自身分識別核心封裝的驗證程式。</span><span class="sxs-lookup"><span data-stu-id="db7ce-152">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="db7ce-153">使用者的預設驗證程式 (`UserValidator`) 具有屬性`AllowOnlyAlphanumericUserNames`具有預設值設定為`true`。</span><span class="sxs-lookup"><span data-stu-id="db7ce-153">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="db7ce-154">密碼的預設驗證程式 (`MinimumLengthValidator`) 可確保該密碼已經至少 6 個字元。</span><span class="sxs-lookup"><span data-stu-id="db7ce-154">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="db7ce-155">這些驗證程式位於屬性`UserManager`，會覆寫如果您想要有自訂的驗證</span><span class="sxs-lookup"><span data-stu-id="db7ce-155">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verifying-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="db7ce-156">驗證 LocalDb 識別資料庫和 Entity Framework 所產生的資料表</span><span class="sxs-lookup"><span data-stu-id="db7ce-156">Verifying the LocalDb Identity Database and Tables Generated by Entity Framework</span></span>

1. <span data-ttu-id="db7ce-157">在**檢視**功能表上，按一下 **伺服器總管**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-157">In the **View** menu, click **Server Explorer**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="db7ce-158">展開**DefaultConnection (WebFormsIdentity)**，依序展開**資料表**，以滑鼠右鍵按一下**AspNetUsers**按一下**顯示資料表資料**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-158">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right click **AspNetUsers** and click **Show Table Data**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configuring-the-application-for-owin-authentication"></a><span data-ttu-id="db7ce-159">設定 OWIN 驗證的應用程式</span><span class="sxs-lookup"><span data-stu-id="db7ce-159">Configuring the application for OWIN authentication</span></span>

<span data-ttu-id="db7ce-160">此時我們只新增了支援以建立使用者。</span><span class="sxs-lookup"><span data-stu-id="db7ce-160">At this point we have only added support for creating users.</span></span> <span data-ttu-id="db7ce-161">現在，我們將示範如何我們新增登入使用者的驗證。</span><span class="sxs-lookup"><span data-stu-id="db7ce-161">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="db7ce-162">ASP.NET Identity 表單驗證使用 Microsoft OWIN 驗證中介軟體。</span><span class="sxs-lookup"><span data-stu-id="db7ce-162">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="db7ce-163">OWIN 的 Cookie 驗證 cookie 和宣告型的驗證機制，可供任何架構上裝載[OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx)或 IIS。</span><span class="sxs-lookup"><span data-stu-id="db7ce-163">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="db7ce-164">使用這個模型，相同的驗證封裝可以用於跨多個架構，包含 ASP.NET MVC 和 Web Form。</span><span class="sxs-lookup"><span data-stu-id="db7ce-164">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="db7ce-165">如需有關專案 Katana 和如何執行中介軟體中主機無從驗證，請參閱[入門 Katana 專案](https://msdn.microsoft.com/magazine/dn451439.aspx)。</span><span class="sxs-lookup"><span data-stu-id="db7ce-165">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="installing-authentication-packages-to-your-application"></a><span data-ttu-id="db7ce-166">驗證封裝安裝至您的應用程式</span><span class="sxs-lookup"><span data-stu-id="db7ce-166">Installing authentication packages to your application</span></span>

1. <span data-ttu-id="db7ce-167">在 [方案總管] 中，以滑鼠右鍵按一下您的專案，然後選取**管理 NuGet 封裝**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-167">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="db7ce-168">在 搜尋文字 方塊 對話方塊中，輸入 「*Identity.Owin*"。</span><span class="sxs-lookup"><span data-stu-id="db7ce-168">In the search text box dialog, type "*Identity.Owin*".</span></span> <span data-ttu-id="db7ce-169">按一下 安裝此套件。</span><span class="sxs-lookup"><span data-stu-id="db7ce-169">Click install for this package.</span></span>   
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image10.png)
2. <span data-ttu-id="db7ce-170">搜尋封裝***Microsoft.Owin.Host.SystemWeb***並安裝它。</span><span class="sxs-lookup"><span data-stu-id="db7ce-170">Search for package ***Microsoft.Owin.Host.SystemWeb*** and install it.</span></span>   

    > [!NOTE]
    > <span data-ttu-id="db7ce-171">**Microsoft.Aspnet.Identity.Owin**封裝包含一組管理與設定 OWIN 驗證中介軟體可供 ASP.NET Identity Core 套件 OWIN 擴充功能類別。</span><span class="sxs-lookup"><span data-stu-id="db7ce-171">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>  
    > <span data-ttu-id="db7ce-172">**Microsoft.Owin.Host.SystemWeb**封裝包含 OWIN 伺服器，可讓 OWIN 應用程式，以使用 ASP.NET 要求管線在 IIS 上執行。</span><span class="sxs-lookup"><span data-stu-id="db7ce-172">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="db7ce-173">如需詳細資訊，請參閱[OWIN 中介軟體在 IIS 中整合管線](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md)。</span><span class="sxs-lookup"><span data-stu-id="db7ce-173">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="adding-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="db7ce-174">新增 OWIN 啟動 「 和驗證組態類別</span><span class="sxs-lookup"><span data-stu-id="db7ce-174">Adding OWIN Startup and Authentication Configuration Classes</span></span>

1. <span data-ttu-id="db7ce-175">在**方案總管 中**，以滑鼠右鍵按一下您的專案，按一下**新增**，然後**加入新項目**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-175">In **Solution Explorer**, right-click your project, click **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="db7ce-176">在 搜尋文字 方塊 對話方塊中，輸入 「*owin*"。</span><span class="sxs-lookup"><span data-stu-id="db7ce-176">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="db7ce-177">將類別 」*啟動*「 按一下**新增**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-177">Name the class "*Startup*" and click **Add**.</span></span>   
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="db7ce-178">在 Startup.cs 檔案中，將反白顯示程式碼來設定 OWIN 的 cookie 驗證，如下所示。</span><span class="sxs-lookup"><span data-stu-id="db7ce-178">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="db7ce-179">這個類別包含`OwinStartup`指定 OWIN 啟動類別的屬性。</span><span class="sxs-lookup"><span data-stu-id="db7ce-179">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="db7ce-180">每個 OWIN 應用程式已啟動類別讓您指定的應用程式管線元件。</span><span class="sxs-lookup"><span data-stu-id="db7ce-180">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="db7ce-181">請參閱[OWIN 啟動類別偵測](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)如需詳細資訊，此模型上。</span><span class="sxs-lookup"><span data-stu-id="db7ce-181">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="adding-web-forms-for-registering-and-logging-in-users"></a><span data-ttu-id="db7ce-182">加入註冊和登入使用者的 Web Form</span><span class="sxs-lookup"><span data-stu-id="db7ce-182">Adding Web Forms for Registering and Logging in Users</span></span>

1. <span data-ttu-id="db7ce-183">開啟*Register.cs*檔案，然後加入下列程式碼的註冊成功時，將登入使用者。</span><span class="sxs-lookup"><span data-stu-id="db7ce-183">Open the *Register.cs* file and add the following code which will log in the user when registration succeeds.</span></span> <span data-ttu-id="db7ce-184">下面反白顯示所做的變更。</span><span class="sxs-lookup"><span data-stu-id="db7ce-184">The changes are highlighted below.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="db7ce-185">架構，因為 ASP.NET Identity 和 OWIN 的 Cookie 驗證是宣告式系統，需要產生應用程式開發人員[ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx)使用者。</span><span class="sxs-lookup"><span data-stu-id="db7ce-185">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="db7ce-186">身分識別的所有宣告的使用者，例如使用者所屬的角色的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="db7ce-186">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="db7ce-187">您也可以在這個階段中加入更多的使用者宣告。</span><span class="sxs-lookup"><span data-stu-id="db7ce-187">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="db7ce-188">您可以使用登入使用者呼叫與 OWIN AuthenticationManager`SignIn`並傳入 ClaimsIdentity，如上所示。</span><span class="sxs-lookup"><span data-stu-id="db7ce-188">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="db7ce-189">這段程式碼將會在使用者登入，並產生以及 cookie。</span><span class="sxs-lookup"><span data-stu-id="db7ce-189">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="db7ce-190">這個呼叫是類似於[FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx)供[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模組。</span><span class="sxs-lookup"><span data-stu-id="db7ce-190">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="db7ce-191">在**方案總管 中**，以滑鼠右鍵按一下專案按一下**新增**，然後**Web Form**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-191">In **Solution Explorer**, right-click your project click **Add**, and then **Web Form**.</span></span> <span data-ttu-id="db7ce-192">Web 表單**登入**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-192">Name the web form **Login**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="db7ce-193">取代內容*Login.aspx*以下列程式碼檔案：</span><span class="sxs-lookup"><span data-stu-id="db7ce-193">Replace the contents of the *Login.aspx* file with the following code:</span></span>  

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="db7ce-194">取代內容*Login.aspx.cs*以下列檔案：</span><span class="sxs-lookup"><span data-stu-id="db7ce-194">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>  

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="db7ce-195">`Page_Load`現在會檢查目前使用者的狀態，並且會根據其`Context.User.Identity.IsAuthenticated`狀態。</span><span class="sxs-lookup"><span data-stu-id="db7ce-195">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>  
    >     <span data-ttu-id="db7ce-196">**在 使用者名稱顯示間隔**: Microsoft ASP.NET Identity Framework 已加入的擴充方法上[System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) ，可讓您取得`UserName`和`UserId`的登入的使用者。</span><span class="sxs-lookup"><span data-stu-id="db7ce-196">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="db7ce-197">這些擴充方法中定義`Microsoft.AspNet.Identity.Core`組件。</span><span class="sxs-lookup"><span data-stu-id="db7ce-197">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="db7ce-198">這些擴充方法會取代[HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="db7ce-198">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="db7ce-199">登入方法：</span><span class="sxs-lookup"><span data-stu-id="db7ce-199">SignIn method:</span></span>   
    >     <span data-ttu-id="db7ce-200">`This` 方法會取代先前`CreateUser_Click`方法，在這個範例和現在已成功建立使用者之後，在使用者的符號。</span><span class="sxs-lookup"><span data-stu-id="db7ce-200">`This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >  <span data-ttu-id="db7ce-201">Microsoft OWIN 架構有加入擴充方法上`System.Web.HttpContext`，可讓您取得的參考`IOwinContext`。</span><span class="sxs-lookup"><span data-stu-id="db7ce-201">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="db7ce-202">這些擴充方法中定義`Microsoft.Owin.Host.SystemWeb`組件。</span><span class="sxs-lookup"><span data-stu-id="db7ce-202">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="db7ce-203">`OwinContext`類別會公開`IAuthenticationManager`屬性，代表目前要求中可取的驗證中介軟體功能。</span><span class="sxs-lookup"><span data-stu-id="db7ce-203">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span>  
    >  <span data-ttu-id="db7ce-204">您可以使用登入使用者`AuthenticationManager`OWIN 並呼叫從`SignIn`和傳入`ClaimsIdentity`如上所示。</span><span class="sxs-lookup"><span data-stu-id="db7ce-204">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn`  and passing in the `ClaimsIdentity`  as shown above.</span></span>   
    >  <span data-ttu-id="db7ce-205">因為 ASP.NET Identity 和 OWIN 的 Cookie 驗證以宣告為基礎的系統，架構都需要應用程式產生`ClaimsIdentity`使用者。</span><span class="sxs-lookup"><span data-stu-id="db7ce-205">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span>   
    >  <span data-ttu-id="db7ce-206">`ClaimsIdentity`有使用者，例如使用者所屬的角色的所有宣告的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="db7ce-206">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="db7ce-207">您也可以在這個階段新增更多的使用者宣告</span><span class="sxs-lookup"><span data-stu-id="db7ce-207">You can also add more claims for the user at this stage</span></span>  
    >  <span data-ttu-id="db7ce-208">這段程式碼將會在使用者登入，並產生以及 cookie。</span><span class="sxs-lookup"><span data-stu-id="db7ce-208">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="db7ce-209">這個呼叫是類似於[FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx)供[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模組。</span><span class="sxs-lookup"><span data-stu-id="db7ce-209">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="db7ce-210">`SignOut` 方法：</span><span class="sxs-lookup"><span data-stu-id="db7ce-210">`SignOut` method:</span></span>   
    >  <span data-ttu-id="db7ce-211">取得參考`AuthenticationManager`OWIN 並呼叫從`SignOut`。</span><span class="sxs-lookup"><span data-stu-id="db7ce-211">Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="db7ce-212">這是類似於[FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx)所使用的方法[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模組。</span><span class="sxs-lookup"><span data-stu-id="db7ce-212">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="db7ce-213">按**Ctrl + F5**建置並執行 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="db7ce-213">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="db7ce-214">輸入新的使用者名稱和密碼，然後按一下 上**註冊**。</span><span class="sxs-lookup"><span data-stu-id="db7ce-214">Enter a new user name and password and then click on **Register**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="db7ce-215">注意： 此時，新的使用者建立並登入。</span><span class="sxs-lookup"><span data-stu-id="db7ce-215">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="db7ce-216">按一下**登出** 按鈕。安裝程式會重新導向至表單中的記錄檔。</span><span class="sxs-lookup"><span data-stu-id="db7ce-216">Click on **Log out** button.You will be redirected to the Log in form.</span></span>
7. <span data-ttu-id="db7ce-217">輸入使用者名稱無效或密碼並按一下上**登入** 按鈕。</span><span class="sxs-lookup"><span data-stu-id="db7ce-217">Enter an invalid user name or password and Click on **Log in** button.</span></span>   
   <span data-ttu-id="db7ce-218">`UserManager.Find`方法會傳回 null，且錯誤訊息: 「*無效的使用者名稱或密碼*」 將會顯示。</span><span class="sxs-lookup"><span data-stu-id="db7ce-218">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
