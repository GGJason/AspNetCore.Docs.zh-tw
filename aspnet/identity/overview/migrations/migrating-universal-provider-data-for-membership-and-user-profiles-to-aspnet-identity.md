---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: 將通用的提供者的資料移轉成員資格和使用者設定檔，以 ASP.NET Identity (C#) |Microsoft 文件
author: rustd
description: 本教學課程中說明的步驟所需移轉使用者和角色的資料，以及使用通用的提供者的現有應用程式所建立的使用者設定檔資料...
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/13/2013
ms.topic: article
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: f65f93b20543d06ea70a9009b6921e297477c99e
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/06/2018
ms.locfileid: "30871567"
---
<a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="5187d-103">將通用的提供者的資料移轉成員資格和使用者設定檔，以 ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="5187d-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="5187d-104">由[Pranav Rastogi](https://github.com/rustd)， [Rick Anderson](https://github.com/Rick-Anderson)， [Robert McMurray](https://github.com/rmcmurray)， [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="5187d-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="5187d-105">本教學課程描述所移轉使用者和角色的資料，以及使用通用的提供者的現有 ASP.NET 身分識別模型的應用程式所建立的使用者設定檔資料所需的步驟。</span><span class="sxs-lookup"><span data-stu-id="5187d-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="5187d-106">方法此處提到移轉使用者設定檔資料可以使用 SQL 成員資格的應用程式中。</span><span class="sxs-lookup"><span data-stu-id="5187d-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>


<span data-ttu-id="5187d-107">使用 Visual Studio 2013 版本，ASP.NET 團隊導入新的 ASP.NET 識別系統，並閱讀更多關於該版本[這裡](../../index.md)。</span><span class="sxs-lookup"><span data-stu-id="5187d-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="5187d-108">要從 web 應用程式移轉的發行項上後續[SQL 成員資格，才能在新的身分識別系統](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)，本文說明如何移轉現有的應用程式，請依照下列使用者和角色管理的提供者模型的步驟加入新的身分識別模型。</span><span class="sxs-lookup"><span data-stu-id="5187d-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="5187d-109">本教學課程的焦點會在移轉使用者設定檔資料，來順暢地將它連結到新的系統。</span><span class="sxs-lookup"><span data-stu-id="5187d-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="5187d-110">移轉使用者和角色的資訊是類似 SQL 的成員資格。</span><span class="sxs-lookup"><span data-stu-id="5187d-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="5187d-111">遵循移轉設定檔資料的方法可以使用 SQL 成員資格的應用程式中。</span><span class="sxs-lookup"><span data-stu-id="5187d-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="5187d-112">例如，我們將開始使用 Visual Studio 2012 中使用的提供者模型所建立的 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="5187d-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="5187d-113">我們將則加入管理設定檔的程式碼、 註冊的使用者、 新增使用者的設定檔資料、 移轉資料庫結構描述，然後變更應用程式使用的識別系統的使用者和角色管理。</span><span class="sxs-lookup"><span data-stu-id="5187d-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="5187d-114">移轉的測試，以使用通用的提供者所建立的使用者應該能夠登入和新的使用者應該能夠註冊。</span><span class="sxs-lookup"><span data-stu-id="5187d-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="5187d-115">您可以找到完整的範例： [ https://github.com/suhasj/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations)。</span><span class="sxs-lookup"><span data-stu-id="5187d-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>


## <a name="profile-data-migration-summary"></a><span data-ttu-id="5187d-116">設定檔資料移轉摘要</span><span class="sxs-lookup"><span data-stu-id="5187d-116">Profile data migration summary</span></span>

<span data-ttu-id="5187d-117">開始之前的移轉，讓我們看看設定檔資料儲存提供者模型中的體驗。</span><span class="sxs-lookup"><span data-stu-id="5187d-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="5187d-118">使用者可以儲存多種方式可以在應用程式的設定檔資料，其中最常見正在使用通用的提供者以及隨附的內建的設定檔提供者。</span><span class="sxs-lookup"><span data-stu-id="5187d-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="5187d-119">這些步驟會包含</span><span class="sxs-lookup"><span data-stu-id="5187d-119">The steps would include</span></span>

1. <span data-ttu-id="5187d-120">加入具有屬性用來儲存設定檔資料的類別。</span><span class="sxs-lookup"><span data-stu-id="5187d-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="5187d-121">加入擴充 'ProfileBase' 和實作方法來取得使用者的上述的設定檔資料的類別。</span><span class="sxs-lookup"><span data-stu-id="5187d-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="5187d-122">使用預設設定檔提供者中的啟用*web.config*檔案，並在步驟 2 以用於存取設定檔資訊中宣告的類別定義。</span><span class="sxs-lookup"><span data-stu-id="5187d-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="5187d-123">設定檔資訊會儲存為序列化的 xml 和資料庫中的 '的設定檔 」 資料表中的二進位資料。</span><span class="sxs-lookup"><span data-stu-id="5187d-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="5187d-124">在移轉之後使用新的 ASP.NET Identity 系統應用程式，會還原序列化的設定檔資訊，並將其儲存為使用者類別上的屬性中。</span><span class="sxs-lookup"><span data-stu-id="5187d-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="5187d-125">每個屬性接著可以對應到使用者資料表中的資料行。</span><span class="sxs-lookup"><span data-stu-id="5187d-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="5187d-126">此處的優點是屬性即可直接使用除了不需要序列化/還原序列化資料資訊每個使用者類別存取它的時間。</span><span class="sxs-lookup"><span data-stu-id="5187d-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="5187d-127">快速入門</span><span class="sxs-lookup"><span data-stu-id="5187d-127">Getting Started</span></span>

1. <span data-ttu-id="5187d-128">在 Visual Studio 2012 中建立新的 ASP.NET 4.5 Web Form 應用程式。</span><span class="sxs-lookup"><span data-stu-id="5187d-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="5187d-129">目前的範例使用 Web Form 範本，但您也可以使用 MVC 應用程式。</span><span class="sxs-lookup"><span data-stu-id="5187d-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="5187d-130">建立新的資料夾 '模型' 儲存設定檔資訊</span><span class="sxs-lookup"><span data-stu-id="5187d-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="5187d-131">例如，讓我們儲存日期的生日、 縣 （市）、 高度和寬度的使用者設定檔中。</span><span class="sxs-lookup"><span data-stu-id="5187d-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="5187d-132">高度和寬度會儲存為自訂類別，稱為 'PersonalStats' 中。</span><span class="sxs-lookup"><span data-stu-id="5187d-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="5187d-133">若要儲存和擷取的設定檔，我們需要可擴充 'ProfileBase' 的類別。</span><span class="sxs-lookup"><span data-stu-id="5187d-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="5187d-134">讓我們來建立新的類別 'AppProfile' 以取得並儲存設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="5187d-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="5187d-135">啟用設定檔中的*web.config*檔案。</span><span class="sxs-lookup"><span data-stu-id="5187d-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="5187d-136">輸入要用於儲存/擷取使用者資訊在步驟 3 中建立的類別名稱。</span><span class="sxs-lookup"><span data-stu-id="5187d-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="5187d-137">取得使用者的設定檔資料，並將其儲存的 'Account' 資料夾中新增的 web form 頁面。</span><span class="sxs-lookup"><span data-stu-id="5187d-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="5187d-138">以滑鼠右鍵按一下專案並選取 加入新項目'。</span><span class="sxs-lookup"><span data-stu-id="5187d-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="5187d-139">加入新 webforms 網頁主版頁面 'AddProfileData.aspx'。</span><span class="sxs-lookup"><span data-stu-id="5187d-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="5187d-140">複製下列 'MainContent' 區段中：</span><span class="sxs-lookup"><span data-stu-id="5187d-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="5187d-141">在程式碼中加入下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="5187d-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="5187d-142">加入命名空間下的 AppProfile 類別定義移除編譯錯誤。</span><span class="sxs-lookup"><span data-stu-id="5187d-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="5187d-143">執行應用程式，並以使用者名稱建立新的使用者 '**olduser'。**</span><span class="sxs-lookup"><span data-stu-id="5187d-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="5187d-144">巡覽至 'AddProfileData' 頁面，並新增使用者設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="5187d-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="5187d-145">您可以驗證的資料會儲存為序列化的 xml，使用 [伺服器總管] 視窗 '的設定檔 」 資料表中。</span><span class="sxs-lookup"><span data-stu-id="5187d-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="5187d-146">在 Visual Studio 中，從 [檢視] 功能表上，選擇 [伺服器總管] '。</span><span class="sxs-lookup"><span data-stu-id="5187d-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="5187d-147">應該是資料庫中定義的資料連線*web.config*檔案。</span><span class="sxs-lookup"><span data-stu-id="5187d-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="5187d-148">按一下即可在資料連線顯示不同的子類別目錄。</span><span class="sxs-lookup"><span data-stu-id="5187d-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="5187d-149">展開以顯示不同的資料表在資料庫中，'設定檔] 上按一下滑鼠右鍵然後選擇 [檢視設定檔資料儲存在設定檔資料表中的 「 顯示資料表資料 」 的 「 資料表 」。</span><span class="sxs-lookup"><span data-stu-id="5187d-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="5187d-150">移轉資料庫結構描述</span><span class="sxs-lookup"><span data-stu-id="5187d-150">Migrating database schema</span></span>

<span data-ttu-id="5187d-151">若要讓現有的資料庫搭配使用識別身分系統，我們需要更新的結構描述中識別資料庫，以支援我們加入至原始資料庫的欄位。</span><span class="sxs-lookup"><span data-stu-id="5187d-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="5187d-152">這可以使用 SQL 指令碼來建立新的資料表，並將複製現有的資訊。</span><span class="sxs-lookup"><span data-stu-id="5187d-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="5187d-153">在 [伺服器總管] 視窗中，展開 'DefaultConnection' 顯示資料表。</span><span class="sxs-lookup"><span data-stu-id="5187d-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="5187d-154">以滑鼠右鍵按一下資料表，然後選取 [新增查詢]</span><span class="sxs-lookup"><span data-stu-id="5187d-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="5187d-155">貼上的 SQL 指令碼，從[ https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt ](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt)並執行它。</span><span class="sxs-lookup"><span data-stu-id="5187d-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="5187d-156">如果重新整理 'DefaultConnection' 時，我們可以看到新資料表隨即加入。</span><span class="sxs-lookup"><span data-stu-id="5187d-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="5187d-157">您可以檢查以查看已移轉的資訊的資料表內的資料。</span><span class="sxs-lookup"><span data-stu-id="5187d-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="5187d-158">應用程式移轉至使用 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="5187d-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="5187d-159">安裝所需的 ASP.NET Identity 的 Nuget 封裝：</span><span class="sxs-lookup"><span data-stu-id="5187d-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="5187d-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="5187d-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="5187d-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="5187d-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="5187d-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="5187d-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="5187d-163">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="5187d-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="5187d-164">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="5187d-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="5187d-165">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="5187d-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="5187d-166">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="5187d-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="5187d-167">在 管理 Nuget 封裝的詳細資訊可以找到[這裡](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span><span class="sxs-lookup"><span data-stu-id="5187d-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="5187d-168">若要使用資料表中的現有資料，我們需要建立模型類別將對應至資料表，並將它們連結身分識別系統中。</span><span class="sxs-lookup"><span data-stu-id="5187d-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="5187d-169">識別合約的一部分，模型類別應實作 Identity.Core dll 中定義的介面，或者也可以擴充現有 Microsoft.AspNet.Identity.EntityFramework 用於這些介面的實作。</span><span class="sxs-lookup"><span data-stu-id="5187d-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="5187d-170">我們會針對角色、 使用者登入和使用者宣告使用現有的類別。</span><span class="sxs-lookup"><span data-stu-id="5187d-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="5187d-171">我們需要自訂的使用者使用我們的範例。</span><span class="sxs-lookup"><span data-stu-id="5187d-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="5187d-172">以滑鼠右鍵按一下專案，並建立新資料夾 'IdentityModels'。</span><span class="sxs-lookup"><span data-stu-id="5187d-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="5187d-173">加入新的 「 使用者 」 類別，如下所示：</span><span class="sxs-lookup"><span data-stu-id="5187d-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="5187d-174">請注意，'ProfileInfo' 現在是使用者類別上的屬性。</span><span class="sxs-lookup"><span data-stu-id="5187d-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="5187d-175">因此，我們可以直接使用設定檔資料使用的使用者類別。</span><span class="sxs-lookup"><span data-stu-id="5187d-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="5187d-176">在將檔案複製**IdentityModels**和**IdentityAccount**下載來源的資料夾 ( [ https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) )。</span><span class="sxs-lookup"><span data-stu-id="5187d-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="5187d-177">這些有剩餘的模型類別和新使用者和角色管理使用 ASP.NET 識別應用程式開發介面所需的頁面。</span><span class="sxs-lookup"><span data-stu-id="5187d-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="5187d-178">可以找到詳細的說明和使用的方法是類似 SQL 的成員資格[這裡](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)。</span><span class="sxs-lookup"><span data-stu-id="5187d-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="5187d-179">將設定檔資料複製到新的資料表</span><span class="sxs-lookup"><span data-stu-id="5187d-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="5187d-180">如先前所述，我們需要還原序列化設定檔資料表中的 xml 資料，並將它儲存在 AspNetUsers 資料表的資料行。</span><span class="sxs-lookup"><span data-stu-id="5187d-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="5187d-181">讓剩下的是，填入資料行的必要資料的上一個步驟中的使用者資料表中建立新的資料行。</span><span class="sxs-lookup"><span data-stu-id="5187d-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="5187d-182">若要這樣做，我們將使用它來填入新建立的資料行，使用者資料表中一次執行主控台應用程式。</span><span class="sxs-lookup"><span data-stu-id="5187d-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="5187d-183">建立新的主控台應用程式中現有的方案。</span><span class="sxs-lookup"><span data-stu-id="5187d-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="5187d-184">安裝最新版的 Entity Framework 套件。</span><span class="sxs-lookup"><span data-stu-id="5187d-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="5187d-185">加入 web 應用程式建立上方，為主控台應用程式的參考。</span><span class="sxs-lookup"><span data-stu-id="5187d-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="5187d-186">以這滑鼠右鍵按一下專案，然後 ' 加入參考，然後方案，然後在專案上按一下，並按一下 確定。</span><span class="sxs-lookup"><span data-stu-id="5187d-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="5187d-187">複製 Program.cs 類別中的程式碼底下。</span><span class="sxs-lookup"><span data-stu-id="5187d-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="5187d-188">此邏輯讀取的每個使用者設定檔資料、 將它序列化為物件 'ProfileInfo' 並將它儲存回資料庫。</span><span class="sxs-lookup"><span data-stu-id="5187d-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="5187d-189">部分使用的模型定義於 'IdentityModels' 資料夾的 web 應用程式專案中，因此您必須將包含對應的命名空間。</span><span class="sxs-lookup"><span data-stu-id="5187d-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="5187d-190">上述程式碼適用於應用程式中的資料庫檔案\_在先前步驟中建立的 web 應用程式專案的儲存資料夾。</span><span class="sxs-lookup"><span data-stu-id="5187d-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="5187d-191">若要參考的請使用 web 應用程式的 web.config 中的連接字串更新主控台應用程式的 app.config 檔案中的連接字串。</span><span class="sxs-lookup"><span data-stu-id="5187d-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="5187d-192">也提供 'AttachDbFilename' 屬性中的完整實體路徑。</span><span class="sxs-lookup"><span data-stu-id="5187d-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="5187d-193">開啟命令提示字元並瀏覽至上面的主控台應用程式的 bin 資料夾。</span><span class="sxs-lookup"><span data-stu-id="5187d-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="5187d-194">執行可執行檔，並檢閱記錄檔輸出，如下列影像所示。</span><span class="sxs-lookup"><span data-stu-id="5187d-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="5187d-195">在 [伺服器總管] 中開啟 'AspNetUsers' 資料表，並確認保存的屬性的新資料行中的資料。</span><span class="sxs-lookup"><span data-stu-id="5187d-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="5187d-196">他們應該更新的相對應的屬性值。</span><span class="sxs-lookup"><span data-stu-id="5187d-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="5187d-197">驗證功能</span><span class="sxs-lookup"><span data-stu-id="5187d-197">Verify functionality</span></span>

<span data-ttu-id="5187d-198">請使用新加入的成員資格頁面從舊的資料庫使用者登入使用 ASP.NET Identity 實作。</span><span class="sxs-lookup"><span data-stu-id="5187d-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="5187d-199">使用者應該能夠使用相同的認證登入。</span><span class="sxs-lookup"><span data-stu-id="5187d-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="5187d-200">請嘗試其他功能，例如新增 OAuth、 建立新的使用者，並變更密碼，新增角色，將使用者新增至角色等等。</span><span class="sxs-lookup"><span data-stu-id="5187d-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="5187d-201">應擷取並儲存在使用者資料表中舊的使用者和新使用者的設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="5187d-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="5187d-202">舊的資料表應該不會再參考。</span><span class="sxs-lookup"><span data-stu-id="5187d-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="5187d-203">結論</span><span class="sxs-lookup"><span data-stu-id="5187d-203">Conclusion</span></span>

<span data-ttu-id="5187d-204">本文說明移轉用於 ASP.NET 識別的成員資格提供者模型的 web 應用程式的程序。</span><span class="sxs-lookup"><span data-stu-id="5187d-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="5187d-205">此外，發行項所述移轉的使用者連接到 身分識別系統的分析資料。</span><span class="sxs-lookup"><span data-stu-id="5187d-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="5187d-206">請留下註解以下問題和移轉您的應用程式時遇到的問題。</span><span class="sxs-lookup"><span data-stu-id="5187d-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="5187d-207">*感謝您 Rick Anderson 和 Robert McMurray 檢閱發行項。*</span><span class="sxs-lookup"><span data-stu-id="5187d-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
