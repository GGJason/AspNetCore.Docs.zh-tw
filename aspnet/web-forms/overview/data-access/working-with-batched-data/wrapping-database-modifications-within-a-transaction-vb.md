---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
title: 資料庫修改 (VB) 在交易內文繞圖 |Microsoft 文件
author: rick-anderson
description: 本教學課程是四個查看更新、 刪除和插入的資料批次中的第一個。 在此教學課程中我們了解資料庫交易如何允許...
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/26/2007
ms.topic: article
ms.assetid: 7d821db5-6cbb-4b38-af14-198f9155fc82
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
msc.type: authoredcontent
ms.openlocfilehash: 2005561755b22f5811d011bd3146853f6cd184af
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/06/2018
ms.locfileid: "30888701"
---
<a name="wrapping-database-modifications-within-a-transaction-vb"></a><span data-ttu-id="eb512-104">包裝資料庫修改 (VB) 在交易內</span><span class="sxs-lookup"><span data-stu-id="eb512-104">Wrapping Database Modifications within a Transaction (VB)</span></span>
====================
<span data-ttu-id="eb512-105">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="eb512-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="eb512-106">[下載程式碼](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip)或[下載 PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="eb512-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span></span>

> <span data-ttu-id="eb512-107">本教學課程是四個查看更新、 刪除和插入的資料批次中的第一個。</span><span class="sxs-lookup"><span data-stu-id="eb512-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="eb512-108">本教學課程中我們了解資料庫交易如何允許批次執行時，成為不可部分完成的作業，可確保，所有步驟都成功或失敗的所有步驟的修改。</span><span class="sxs-lookup"><span data-stu-id="eb512-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="eb512-109">簡介</span><span class="sxs-lookup"><span data-stu-id="eb512-109">Introduction</span></span>

<span data-ttu-id="eb512-110">如我們所見開頭[概觀的插入、 更新和刪除資料](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md)教學課程中，GridView 提供內建支援的資料列層級編輯和刪除。</span><span class="sxs-lookup"><span data-stu-id="eb512-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="eb512-111">透過按幾下滑鼠就可能不需要撰寫一行程式碼，建立豐富的資料修改介面，因此只要您內容的編輯和刪除以每個資料列的基礎。</span><span class="sxs-lookup"><span data-stu-id="eb512-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="eb512-112">不過，在某些情況下這還不足夠，因此需要為使用者提供編輯或刪除記錄的批次的能力。</span><span class="sxs-lookup"><span data-stu-id="eb512-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="eb512-113">比方說，最網頁型電子郵件用戶端使用方格，列出每個訊息，每個資料列包含核取方塊，以及電子郵件中的 s 資訊 （例如主旨、 寄件者，等等）。</span><span class="sxs-lookup"><span data-stu-id="eb512-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="eb512-114">這個介面允許使用者刪除它們，然後按一下 [刪除選取的郵件] 按鈕的多個訊息。</span><span class="sxs-lookup"><span data-stu-id="eb512-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="eb512-115">理想情況下，使用者通常編輯多筆不同記錄批次編輯介面。</span><span class="sxs-lookup"><span data-stu-id="eb512-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="eb512-116">而不是強迫使用者按一下 編輯、 其變更，必須修改每一筆記錄，然後按一下 更新，批次編輯介面呈現其編輯介面與每個資料列。</span><span class="sxs-lookup"><span data-stu-id="eb512-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="eb512-117">使用者可以快速修改需要變更的資料列集，並按一下 [全部更新] 按鈕，以儲存這些變更。</span><span class="sxs-lookup"><span data-stu-id="eb512-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="eb512-118">在這組教學課程中，我們將檢驗如何建立介面的插入、 編輯和刪除批次的資料。</span><span class="sxs-lookup"><span data-stu-id="eb512-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="eb512-119">執行批次作業時它來判斷是否應該可以針對某些成功的批次中的作業時的其他重要 s 失敗。</span><span class="sxs-lookup"><span data-stu-id="eb512-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="eb512-120">請考慮刪除介面-採取的動作已成功刪除第一個選取的記錄，但第二個失敗，例如，因為外部索引鍵條件約束違規的緣故，如果批次？</span><span class="sxs-lookup"><span data-stu-id="eb512-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="eb512-121">應該先記錄的刪除復原，或可以接受第一筆記錄，保留已刪除？</span><span class="sxs-lookup"><span data-stu-id="eb512-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="eb512-122">如果您想要當成處理的批次作業[不可部分完成的作業](http://en.wikipedia.org/wiki/Atomic_operation)，其中是的所有步驟成功或的所有步驟失敗，則必須予以增加以包含支援資料存取層一個[資料庫交易](http://en.wikipedia.org/wiki/Database_transaction)。</span><span class="sxs-lookup"><span data-stu-id="eb512-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="eb512-123">資料庫交易保證不可部份完成性的一組`INSERT`， `UPDATE`，和`DELETE`陳述式起交易之下執行，而且是大多數所有新型態的資料庫系統所支援的功能。</span><span class="sxs-lookup"><span data-stu-id="eb512-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="eb512-124">本教學課程中我們將探討如何擴充 DAL 使用資料庫交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="eb512-125">後續的教學課程會檢查批次插入、 更新和刪除介面實作的 web 網頁。</span><span class="sxs-lookup"><span data-stu-id="eb512-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="eb512-126">Let s 開始 ！</span><span class="sxs-lookup"><span data-stu-id="eb512-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="eb512-127">修改在批次交易中的資料時，不一定需要不可部份完成性。</span><span class="sxs-lookup"><span data-stu-id="eb512-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="eb512-128">在某些情況下，可能會接受已成功修改某些資料，有些是在相同批次失敗，例如當從網頁型電子郵件用戶端刪除一組電子郵件。</span><span class="sxs-lookup"><span data-stu-id="eb512-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="eb512-129">如果沒有 s 處理透過刪除資料庫錯誤中途島，它可能是可接受處理不會發生錯誤的記錄保留已刪除的 s。</span><span class="sxs-lookup"><span data-stu-id="eb512-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="eb512-130">在這種情況下，DAL 不必修改為支援資料庫的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="eb512-131">有其他批次作業的情況下，然而，不可部分完成性很重要。</span><span class="sxs-lookup"><span data-stu-id="eb512-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="eb512-132">當客戶會將她資金從銀行帳戶移至另一個時，必須執行兩項作業： 必須扣除的第一個帳戶，然後加入第二個款項。</span><span class="sxs-lookup"><span data-stu-id="eb512-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="eb512-133">銀行可能不介意成功的第一個步驟，但是第二個步驟失敗，客戶會理解會感到生氣。</span><span class="sxs-lookup"><span data-stu-id="eb512-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="eb512-134">我建議您在本教學課程工作，並實作至 DAL 支援資料庫的交易，即使您不打算使用它們在批次的插入、 更新和刪除我們會建置下列三個教學課程中的介面增強功能。</span><span class="sxs-lookup"><span data-stu-id="eb512-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="eb512-135">交易的概觀</span><span class="sxs-lookup"><span data-stu-id="eb512-135">An Overview of Transactions</span></span>

<span data-ttu-id="eb512-136">大部分資料庫都包含支援*交易*，可讓多個資料庫命令，以便將標準群組為單一邏輯工作單位。</span><span class="sxs-lookup"><span data-stu-id="eb512-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="eb512-137">資料庫命令組成交易保證都是不可部分完成，這表示，所有的命令將會失敗或所有將會成功。</span><span class="sxs-lookup"><span data-stu-id="eb512-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="eb512-138">一般情況下，交易是透過使用下列模式的 SQL 陳述式的方式實作：</span><span class="sxs-lookup"><span data-stu-id="eb512-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="eb512-139">表示開始的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="eb512-140">執行 SQL 陳述式組成的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="eb512-141">如果其中一種從步驟 2 中，復原交易的陳述式錯誤。</span><span class="sxs-lookup"><span data-stu-id="eb512-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="eb512-142">如果所有的步驟 2 中的陳述式完成不會發生錯誤時，會認可交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="eb512-143">SQL 陳述式，用來建立、 認可和回復時撰寫 SQL 指令碼或建立預存程序，交易也可以手動輸入或透過程式設計表示使用 ADO.NET 或中的類別[ `System.Transactions`命名空間](https://msdn.microsoft.com/library/system.transactions.aspx)。</span><span class="sxs-lookup"><span data-stu-id="eb512-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="eb512-144">在此教學課程中我們只會檢查管理使用 ADO.NET 的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="eb512-145">在未來的教學課程中我們將探討如何使用預存程序中的資料存取層，此時，我們將探討 SQL 陳述式來建立、 回復，並認可交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="eb512-146">在此同時，請參閱[管理 SQL Server 預存程序中的交易](http://www.4guysfromrolla.com/webtech/080305-1.shtml)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="eb512-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="eb512-147">[ `TransactionScope`類別](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx)中`System.Transactions`命名空間可讓開發人員以程式設計方式將一系列陳述式包裝在交易範圍內，而且包括牽涉到多個複雜交易支援來源，例如兩個不同的資料庫或甚至異質資料存放區，例如 Microsoft SQL Server 資料庫、 Oracle 資料庫，以及 Web 服務的類型。</span><span class="sxs-lookup"><span data-stu-id="eb512-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="eb512-148">我我們決定要使用 ADO.NET 交易，而不是本教學課程`TransactionScope`類別因為 ADO.NET 是更特定的資料庫交易和在許多情況下，是最少需要大量的資源。</span><span class="sxs-lookup"><span data-stu-id="eb512-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="eb512-149">此外，在某些狀況下`TransactionScope`類別會使用 Microsoft Distributed Transaction Coordinator (MSDTC)。</span><span class="sxs-lookup"><span data-stu-id="eb512-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="eb512-150">設定、 實作及效能問題周圍 MSDTC 使得特製化而進階主題和這些教學課程的範圍之外。</span><span class="sxs-lookup"><span data-stu-id="eb512-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="eb512-151">當使用 SqlClient 提供者在 ADO.NET 中，會透過呼叫初始化交易[`SqlConnection`類別](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx)s [ `BeginTransaction`方法](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx)，它會傳回[ `SqlTransaction`物件](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx)。</span><span class="sxs-lookup"><span data-stu-id="eb512-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="eb512-152">結構的交易都放置在資料修改陳述式`try...catch`區塊。</span><span class="sxs-lookup"><span data-stu-id="eb512-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="eb512-153">如果發生錯誤的陳述式中`try`封鎖，請執行傳輸至`catch`區塊，其中交易可以回復透過`SqlTransaction`物件 s [ `Rollback`方法](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx)。</span><span class="sxs-lookup"><span data-stu-id="eb512-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="eb512-154">如果成功，所有的陳述式完成呼叫`SqlTransaction`物件 s [ `Commit`方法](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx)結尾`try`區塊認可交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="eb512-155">下列程式碼片段會示範這個模式。</span><span class="sxs-lookup"><span data-stu-id="eb512-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="eb512-156">請參閱[維護資料庫的一致性與交易](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)的其他語法和範例使用 ADO.NET 的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample1.vb)]

<span data-ttu-id="eb512-157">根據預設，具類型資料集內 Tableadapter 請勿使用交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="eb512-158">若要提供交易支援，我們需要擴充的 TableAdapter 類別，包括使用上述的模式來執行一系列的資料修改陳述式的範圍內的交易的其他方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="eb512-159">在步驟 2 中，我們會看到如何使用部分類別新增這些方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="eb512-160">步驟 1： 建立工作批次的資料 Web 網頁</span><span class="sxs-lookup"><span data-stu-id="eb512-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="eb512-161">我們可以開始探索如何加強 DAL 支援資料庫的交易之前，可讓 s 先花點時間來建立 ASP.NET web pages，我們需要在此教學課程及遵循的三個。</span><span class="sxs-lookup"><span data-stu-id="eb512-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="eb512-162">加入新的資料夾，名為啟動`BatchData`然後加入下列的 asp.net WEB 網頁、 將相關聯的每一頁`Site.master`主版頁面。</span><span class="sxs-lookup"><span data-stu-id="eb512-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![如需 SqlDataSource 相關教學課程加入 ASP.NET 網頁](wrapping-database-modifications-within-a-transaction-vb/_static/image1.gif)

<span data-ttu-id="eb512-164">**圖 1**： 加入 ASP.NET 網頁的 SqlDataSource 相關教學課程</span><span class="sxs-lookup"><span data-stu-id="eb512-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="eb512-165">如同其他資料夾，`Default.aspx`將使用`SectionLevelTutorialListing.ascx`列出的教學課程 > 一節中的使用者控制項。</span><span class="sxs-lookup"><span data-stu-id="eb512-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="eb512-166">因此，新增此使用者控制項加入`Default.aspx`拖曳到頁面的設計 檢視中的 方案總管 中。</span><span class="sxs-lookup"><span data-stu-id="eb512-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="eb512-167">[![將 SectionLevelTutorialListing.ascx 使用者控制項加入至 Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span></span>

<span data-ttu-id="eb512-168">**圖 2**： 新增`SectionLevelTutorialListing.ascx`使用者控制項加入`Default.aspx`([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span></span>


<span data-ttu-id="eb512-169">最後，將這些四個頁面加入做為項目至`Web.sitemap`檔案。</span><span class="sxs-lookup"><span data-stu-id="eb512-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="eb512-170">具體來說，自訂之後加入下列標記網站導覽`<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="eb512-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample2.xml)]

<span data-ttu-id="eb512-171">在更新之後， `Web.sitemap`，花一點時間來檢視此教學課程網站，透過瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="eb512-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="eb512-172">在左側功能表現在包含批次的資料教學課程使用的項目。</span><span class="sxs-lookup"><span data-stu-id="eb512-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![批次的資料教學課程使用的站台地圖現在包含的項目](wrapping-database-modifications-within-a-transaction-vb/_static/image3.gif)

<span data-ttu-id="eb512-174">**圖 3**： 批次的資料教學課程使用的站台地圖現在包含的項目</span><span class="sxs-lookup"><span data-stu-id="eb512-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="eb512-175">步驟 2： 更新資料存取層來支援資料庫的交易</span><span class="sxs-lookup"><span data-stu-id="eb512-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="eb512-176">在 第一個教學課程中，我們所討論[建立資料存取層](../introduction/creating-a-data-access-layer-vb.md)，型別資料集，在我們的 DAL 組成 Datatable 和 Tableadapter。</span><span class="sxs-lookup"><span data-stu-id="eb512-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="eb512-177">Datatable 保存的資料，雖然 Tableadapter 提供的功能，從資料庫讀入 Datatable，Datatable 等所做的變更更新資料庫。</span><span class="sxs-lookup"><span data-stu-id="eb512-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="eb512-178">前文提過，Tableadapter 會提供兩種模式來更新資料，我稱為批次更新與 DB Direct。</span><span class="sxs-lookup"><span data-stu-id="eb512-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="eb512-179">批次更新模式中，使用 TableAdapter 會傳遞資料集、 資料表或資料行的集合。</span><span class="sxs-lookup"><span data-stu-id="eb512-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="eb512-180">這項資料會列舉和每個插入、 修改或刪除資料列， `InsertCommand`， `UpdateCommand`，或`DeleteCommand`執行。</span><span class="sxs-lookup"><span data-stu-id="eb512-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="eb512-181">DB Direct 模式中，使用 TableAdapter 會改為傳遞所需的插入、 更新或刪除單一資料錄的資料行的值。</span><span class="sxs-lookup"><span data-stu-id="eb512-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="eb512-182">DB 直接模式方法再使用這些傳入的值來執行適當`InsertCommand`， `UpdateCommand`，或`DeleteCommand`陳述式。</span><span class="sxs-lookup"><span data-stu-id="eb512-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="eb512-183">不論使用的更新模式，Tableadapter 自動產生的方法不會使用交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="eb512-184">依預設每個插入、 更新或刪除由 TableAdapter 會被視為單一的個別作業。</span><span class="sxs-lookup"><span data-stu-id="eb512-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="eb512-185">比方說，設想 DB Direct 模式使用 BLL 中某些程式碼，將十筆記錄插入資料庫。</span><span class="sxs-lookup"><span data-stu-id="eb512-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="eb512-186">此程式碼會呼叫 tableadapter`Insert`方法十倍。</span><span class="sxs-lookup"><span data-stu-id="eb512-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="eb512-187">如果前五個插入成功，但卻造成例外狀況的第六個的其中一個，插入的前五個記錄會保留在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="eb512-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="eb512-188">同樣地，如果批次更新模式用來執行插入、 更新與刪除導引到插入經過修改，以及刪除 DataTable 中的資料列，如果第一個的一些修改成功，但更新版本時發生錯誤，這些更早的修改，完成會保留在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="eb512-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="eb512-189">在某些情況下我們想要確保之間修改的一系列的不可部份完成性。</span><span class="sxs-lookup"><span data-stu-id="eb512-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="eb512-190">若要完成此我們必須加入執行的新方法，以手動方式擴增 TableAdapter `InsertCommand`， `UpdateCommand`，和`DeleteCommand`s 起的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="eb512-191">在[建立資料存取層](../introduction/creating-a-data-access-layer-vb.md)我們探討了使用[部分類別](http://en.wikipedia.org/wiki/Partial_type)以擴充輸入資料集內 Datatable 的功能。</span><span class="sxs-lookup"><span data-stu-id="eb512-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="eb512-192">這項技術也可以搭配 Tableadapter。</span><span class="sxs-lookup"><span data-stu-id="eb512-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="eb512-193">型別資料集`Northwind.xsd`位於`App_Code`資料夾的`DAL`子資料夾。</span><span class="sxs-lookup"><span data-stu-id="eb512-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="eb512-194">建立子資料夾中的`DAL`資料夾名為`TransactionSupport`並加入新的類別檔案命名為`ProductsTableAdapter.TransactionSupport.vb`（請參閱圖 4）。</span><span class="sxs-lookup"><span data-stu-id="eb512-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.vb` (see Figure 4).</span></span> <span data-ttu-id="eb512-195">這個檔案會保留部分實作`ProductsTableAdapter`包含用於執行資料修改使用交易的方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![加入名為 TransactionSupport 的資料夾和名為 ProductsTableAdapter.TransactionSupport.vb 類別檔案](wrapping-database-modifications-within-a-transaction-vb/_static/image4.gif)

<span data-ttu-id="eb512-197">**圖 4**： 新增名為資料夾`TransactionSupport`和名為的類別檔案 `ProductsTableAdapter.TransactionSupport.vb`</span><span class="sxs-lookup"><span data-stu-id="eb512-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.vb`</span></span>


<span data-ttu-id="eb512-198">輸入下列程式碼`ProductsTableAdapter.TransactionSupport.vb`檔案：</span><span class="sxs-lookup"><span data-stu-id="eb512-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.vb` file:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample3.vb)]

<span data-ttu-id="eb512-199">`Partial`類別宣告中的關鍵字指示編譯器中新增的成員會加入至`ProductsTableAdapter`類別`NorthwindTableAdapters`命名空間。</span><span class="sxs-lookup"><span data-stu-id="eb512-199">The `Partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="eb512-200">請注意`Imports System.Data.SqlClient`在檔案最上方的陳述式。</span><span class="sxs-lookup"><span data-stu-id="eb512-200">Note the `Imports System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="eb512-201">由於 TableAdapter 已設定為使用 SqlClient 提供者，在內部使用[ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx)其命令發出至資料庫的物件。</span><span class="sxs-lookup"><span data-stu-id="eb512-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="eb512-202">因此，我們需要使用`SqlTransaction`類別來開始交易，然後加以認可或回復它。</span><span class="sxs-lookup"><span data-stu-id="eb512-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="eb512-203">如果您使用 Microsoft SQL Server 以外的資料存放區，您必須使用適當的提供者。</span><span class="sxs-lookup"><span data-stu-id="eb512-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="eb512-204">這些方法提供啟動，復原所需的建置組塊，並認可交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="eb512-205">它們就會標示`Public`，好讓他們能夠從內使用`ProductsTableAdapter`、 從另一個類別中 DAL 或從另一層的架構，例如 BLL 中。</span><span class="sxs-lookup"><span data-stu-id="eb512-205">They are marked `Public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="eb512-206">`BeginTransaction` 開啟內部 tableadapter `SqlConnection` （如有需要），開始的交易，並將其指派給`Transaction`屬性，並將交易附加至內部`SqlDataAdapter`s`SqlCommand`物件。</span><span class="sxs-lookup"><span data-stu-id="eb512-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="eb512-207">`CommitTransaction` 和`RollbackTransaction`呼叫`Transaction`物件 s`Commit`和`Rollback`方法，分別之前關閉內部`Connection`物件。</span><span class="sxs-lookup"><span data-stu-id="eb512-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="eb512-208">步驟 3： 加入方法來更新及刪除起交易資料</span><span class="sxs-lookup"><span data-stu-id="eb512-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="eb512-209">利用這些方法完成，我們重新準備好將方法加入至`ProductsDataTable`或 BLL 執行一系列的交易起命令。</span><span class="sxs-lookup"><span data-stu-id="eb512-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="eb512-210">下列方法會使用批次更新模式更新`ProductsDataTable`執行個體使用的交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="eb512-211">它藉由呼叫會啟動交易`BeginTransaction`方法，然後使用`Try...Catch`發出資料修改陳述式區塊。</span><span class="sxs-lookup"><span data-stu-id="eb512-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `Try...Catch` block to issue the data modification statements.</span></span> <span data-ttu-id="eb512-212">如果呼叫`Adapter`物件 s`Update`方法導致例外狀況，執行會傳輸至`catch`交易將回復的區塊，重新擲回的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="eb512-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="eb512-213">請記得，`Update`方法會實作批次更新模式列舉所提供的資料列所`ProductsDataTable`並執行必要`InsertCommand`， `UpdateCommand`，和`DeleteCommand`s。</span><span class="sxs-lookup"><span data-stu-id="eb512-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="eb512-214">如果其中一個這些命令會產生錯誤，會復原交易，並復原先前交易的存留期間所做的變更。</span><span class="sxs-lookup"><span data-stu-id="eb512-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="eb512-215">應該`Update`陳述式完成不會發生錯誤，整個認可交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample4.vb)]

<span data-ttu-id="eb512-216">新增`UpdateWithTransaction`方法`ProductsTableAdapter`類別中的部分類別透過`ProductsTableAdapter.TransactionSupport.vb`。</span><span class="sxs-lookup"><span data-stu-id="eb512-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.vb`.</span></span> <span data-ttu-id="eb512-217">或者，您可以將此方法加入到商務邏輯層的`ProductsBLL`次要進行一些語法變更的類別。</span><span class="sxs-lookup"><span data-stu-id="eb512-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="eb512-218">也就是關鍵字`Me`中`Me.BeginTransaction()`， `Me.CommitTransaction()`，和`Me.RollbackTransaction()`會想要取代`Adapter`(請記得，`Adapter`是中的屬性名稱`ProductsBLL`型別的`ProductsTableAdapter`)。</span><span class="sxs-lookup"><span data-stu-id="eb512-218">Namely, the keyword `Me` in `Me.BeginTransaction()`, `Me.CommitTransaction()`, and `Me.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="eb512-219">`UpdateWithTransaction`方法會使用批次更新模式中，但是一系列的 DB 直接呼叫也可以使用如下所示的方法，在交易範圍內。</span><span class="sxs-lookup"><span data-stu-id="eb512-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="eb512-220">`DeleteProductsWithTransaction`方法接受做為輸入`List(Of T)`型別的`Integer`，這是`ProductID`要刪除。</span><span class="sxs-lookup"><span data-stu-id="eb512-220">The `DeleteProductsWithTransaction` method accepts as input a `List(Of T)` of type `Integer`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="eb512-221">方法會起始交易，透過對呼叫`BeginTransaction`，然後在`Try`封鎖，因此請逐一呼叫 DB Direct 模式提供的清單`Delete`每個方法`ProductID`值。</span><span class="sxs-lookup"><span data-stu-id="eb512-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `Try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="eb512-222">如果任何呼叫`Delete`失敗，控制權會轉移到`Catch`區塊其中交易會復原並重新擲回的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="eb512-222">If any of the calls to `Delete` fails, control is transferred to the `Catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="eb512-223">如果所有呼叫`Delete`成功，則會認可交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="eb512-224">將此方法加入`ProductsBLL`類別。</span><span class="sxs-lookup"><span data-stu-id="eb512-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample5.vb)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="eb512-225">套用交易跨多個 TableAdapters</span><span class="sxs-lookup"><span data-stu-id="eb512-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="eb512-226">檢查此教學課程中的交易相關程式碼可讓多個陳述式針對`ProductsTableAdapter`被視為不可部分完成的作業。</span><span class="sxs-lookup"><span data-stu-id="eb512-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="eb512-227">但多個不同的資料庫資料表的修改需要自動執行該怎麼辦？</span><span class="sxs-lookup"><span data-stu-id="eb512-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="eb512-228">比方說，當刪除類別目錄，我們可能會先想要重新指派其目前的產品，其他類別目錄。</span><span class="sxs-lookup"><span data-stu-id="eb512-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="eb512-229">應該執行這兩個步驟重新指派的產品和刪除類別目錄，成為不可部分完成的作業。</span><span class="sxs-lookup"><span data-stu-id="eb512-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="eb512-230">但是`ProductsTableAdapter`包含只修改方法`Products`資料表和`CategoriesTableAdapter`包含只修改方法`Categories`資料表。</span><span class="sxs-lookup"><span data-stu-id="eb512-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="eb512-231">如何在交易可以包含這兩個 Tableadapter？</span><span class="sxs-lookup"><span data-stu-id="eb512-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="eb512-232">其中一個選項是將方法加入`CategoriesTableAdapter`名為`DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`並使用該方法呼叫的預存程序，同時重新指派的產品，並刪除預存程序內所定義的交易範圍內的分類。</span><span class="sxs-lookup"><span data-stu-id="eb512-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="eb512-233">我們會探討如何開始、 認可和回復交易，預存程序在未來的教學課程。</span><span class="sxs-lookup"><span data-stu-id="eb512-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="eb512-234">另一個選項是建立協助程式類別中包含的 DAL`DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="eb512-235">這個方法會建立的執行個體`CategoriesTableAdapter`和`ProductsTableAdapter`，然後設定這些兩個 Tableadapter`Connection`屬性至相同`SqlConnection`執行個體。</span><span class="sxs-lookup"><span data-stu-id="eb512-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="eb512-236">在該點，其中之一的兩個 Tableadapter 會起始交易呼叫`BeginTransaction`。</span><span class="sxs-lookup"><span data-stu-id="eb512-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="eb512-237">重新指派的產品和刪除類別目錄的 Tableadapter 方法會叫用`Try...Catch`與交易認可或回復回復為所需的區塊。</span><span class="sxs-lookup"><span data-stu-id="eb512-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `Try...Catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="eb512-238">步驟 4： 加入`UpdateWithTransaction`商務邏輯層的方法</span><span class="sxs-lookup"><span data-stu-id="eb512-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="eb512-239">步驟 3 新增`UpdateWithTransaction`方法`ProductsTableAdapter`DAL 中。</span><span class="sxs-lookup"><span data-stu-id="eb512-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="eb512-240">我們應該新增 BLL 對應的方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="eb512-241">雖然展示層無法直接向要叫用 DAL 呼叫`UpdateWithTransaction`這些教學課程有 strived 方法，來定義從展示層 DAL，以隔離的多層式的架構。</span><span class="sxs-lookup"><span data-stu-id="eb512-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="eb512-242">因此，它 behooves 我們繼續為此方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="eb512-243">開啟`ProductsBLL`類別檔案，並新增名為`UpdateWithTransaction`只需呼叫到對應的 DAL 方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="eb512-244">現在應該在兩個新方法`ProductsBLL`: `UpdateWithTransaction`，其中您剛才加入和`DeleteProductsWithTransaction`，已加入在步驟 3 中。</span><span class="sxs-lookup"><span data-stu-id="eb512-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample6.vb)]

> [!NOTE]
> <span data-ttu-id="eb512-245">這些方法不包含`DataObjectMethodAttribute`屬性中的大多數其他方法來指派`ProductsBLL`類別，因為我們將會叫用這些方法直接從 ASP.NET 網頁程式碼後置類別。</span><span class="sxs-lookup"><span data-stu-id="eb512-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="eb512-246">請記得，`DataObjectMethodAttribute`用於哪種方法應該會出現在 ObjectDataSource 的設定資料來源精靈] 和 [索引標籤 （SELECT、 UPDATE、 INSERT 或 DELETE） 的旗標。</span><span class="sxs-lookup"><span data-stu-id="eb512-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="eb512-247">因為 GridView 缺少批次編輯或刪除任何內建支援，我們必須以程式設計方式叫用這些方法，而不是使用宣告式程式碼可用的方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="eb512-248">步驟 5： 自動更新從展示層的資料庫資料</span><span class="sxs-lookup"><span data-stu-id="eb512-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="eb512-249">為了說明交易已更新記錄的批次時的效果，讓 s 建立列出 GridView 中的所有產品，並包含按鈕 Web 使用者介面控制項，當按下，重新指派產品`CategoryID`值。</span><span class="sxs-lookup"><span data-stu-id="eb512-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="eb512-250">類別目錄重新指派會特別的是，進度，如此第一個有幾項產品皆有效`CategoryID`指派不存在的值則是故意`CategoryID`值。</span><span class="sxs-lookup"><span data-stu-id="eb512-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="eb512-251">如果我們嘗試將與產品更新資料庫的`CategoryID`不符合現有分類的`CategoryID`，外部索引鍵條件約束違規會發生，且會引發例外狀況。</span><span class="sxs-lookup"><span data-stu-id="eb512-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="eb512-252">我們會看到在這個範例是，當使用異動從外部索引鍵條件約束違規引發的例外狀況會導致先前有效`CategoryID`回復變更。</span><span class="sxs-lookup"><span data-stu-id="eb512-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="eb512-253">當未使用的交易，不過，會保持初始類別目錄的修改。</span><span class="sxs-lookup"><span data-stu-id="eb512-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="eb512-254">先開啟`Transactions.aspx`頁面`BatchData`資料夾，然後從 [工具箱] 拖曳至設計工具拖曳 GridView。</span><span class="sxs-lookup"><span data-stu-id="eb512-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="eb512-255">設定其`ID`至`Products`和其智慧標籤上，從繫結到名為新 ObjectDataSource `ProductsDataSource`。</span><span class="sxs-lookup"><span data-stu-id="eb512-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="eb512-256">設定提取資料的來源 ObjectDataSource`ProductsBLL`類別的`GetProducts`方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="eb512-257">這將是唯讀的 GridView，因此設定下拉式清單中更新、 插入和刪除索引標籤，以 （無） 與按一下 [完成]。</span><span class="sxs-lookup"><span data-stu-id="eb512-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="eb512-258">[![設定為使用 ProductsBLL 類別的 GetProducts 方法 ObjectDataSource](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-258">[![Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span></span>

<span data-ttu-id="eb512-259">**圖 5**： 設定要使用 ObjectDataSource`ProductsBLL`類別 s`GetProducts`方法 ([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-259">**Figure 5**: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span></span>


<span data-ttu-id="eb512-260">[![設定下拉式清單中更新、 插入和刪除 （無） 索引標籤](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span></span>

<span data-ttu-id="eb512-261">**圖 6**： 下拉式清單中設定更新、 插入和刪除的索引標籤 （無） ([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span></span>


<span data-ttu-id="eb512-262">完成設定資料來源精靈之後，Visual Studio 會建立 BoundFields 及其產品資料欄位。</span><span class="sxs-lookup"><span data-stu-id="eb512-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="eb512-263">移除所有的這些欄位，除了`ProductID`， `ProductName`， `CategoryID`，和`CategoryName`並重新命名`ProductName`和`CategoryName`BoundFields`HeaderText`屬性 Product 和 Category，分別。</span><span class="sxs-lookup"><span data-stu-id="eb512-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="eb512-264">從智慧標籤中，核取 [啟用分頁] 選項。</span><span class="sxs-lookup"><span data-stu-id="eb512-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="eb512-265">進行這些修改後, GridView 和 ObjectDataSource s 宣告式標記看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="eb512-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample7.aspx)]

<span data-ttu-id="eb512-266">接下來，加入三個按鈕 Web 控制項上方 GridView。</span><span class="sxs-lookup"><span data-stu-id="eb512-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="eb512-267">重新整理方格、 修改分類 （與交易） 的第二個 s 和修改類別 （不含交易） 的第一個 s 設 s 文字屬性的第一個按鈕。</span><span class="sxs-lookup"><span data-stu-id="eb512-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample8.aspx)]

<span data-ttu-id="eb512-268">此時在 Visual Studio 中的 [設計] 檢視看起來應該類似螢幕擷取畫面圖 7 所示。</span><span class="sxs-lookup"><span data-stu-id="eb512-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="eb512-269">[![此頁面包含的 GridView 和三個按鈕 Web 控制項](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span></span>

<span data-ttu-id="eb512-270">**圖 7**: 頁面包含的 GridView 和三個按鈕 Web 控制項 ([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span></span>


<span data-ttu-id="eb512-271">建立三個按鈕 s 的每個事件處理常式`Click`事件，並使用下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="eb512-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample9.vb)]

<span data-ttu-id="eb512-272">重新整理按鈕 s`Click`事件處理常式只會重新繫結至 GridView 的資料藉由呼叫`Products`GridView 的`DataBind`方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="eb512-273">第二個事件處理常式會重新指派產品`CategoryID`s，並使用新的交易方法，從執行資料庫 BLL 更新起交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="eb512-274">請注意，每個產品 s`CategoryID`任意設為相同的值做為其`ProductID`。</span><span class="sxs-lookup"><span data-stu-id="eb512-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="eb512-275">這將可以正常運作的第幾項產品，因為這些產品具有`ProductID`值時，會發生對應至有效`CategoryID`s。</span><span class="sxs-lookup"><span data-stu-id="eb512-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="eb512-276">但一次`ProductID`s 開始變得過大，此巧合重疊`ProductID`s 和`CategoryID`s 不再適用。</span><span class="sxs-lookup"><span data-stu-id="eb512-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="eb512-277">第三個`Click`事件處理常式更新產品`CategoryID`中相同的方式，但會將更新傳送到資料庫時使用`ProductsTableAdapter`s 預設`Update`方法。</span><span class="sxs-lookup"><span data-stu-id="eb512-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="eb512-278">這`Update`方法不會換一系列的命令在交易內，讓第一個遇到的外部索引鍵條件約束違規錯誤之前進行這些變更將會保存。</span><span class="sxs-lookup"><span data-stu-id="eb512-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="eb512-279">若要示範此行為，請造訪此頁透過瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="eb512-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="eb512-280">一開始您應該看到第一頁資料，如圖 8 所示。</span><span class="sxs-lookup"><span data-stu-id="eb512-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="eb512-281">接下來，按一下 [修改類別 （與交易）] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="eb512-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="eb512-282">這將導致回傳，並嘗試更新的所有產品`CategoryID`等值，但會導致外部索引鍵條件約束違規 （請參閱圖 9）。</span><span class="sxs-lookup"><span data-stu-id="eb512-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="eb512-283">[![中可分頁的 GridView 會顯示產品](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span></span>

<span data-ttu-id="eb512-284">**圖 8**: 產品會顯示在分頁 GridView ([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span></span>


<span data-ttu-id="eb512-285">[![重新指派的分類會導致外部索引鍵條件約束違規](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span></span>

<span data-ttu-id="eb512-286">**圖 9**： 重新分類中的結果，外部索引鍵條件約束違規 ([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span></span>


<span data-ttu-id="eb512-287">現在叫用瀏覽器 s [上一頁] 按鈕，然後按一下 [重新整理格線] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="eb512-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="eb512-288">在資料重新整理時您應該看到完全相同的輸出，如圖 8 所示。</span><span class="sxs-lookup"><span data-stu-id="eb512-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="eb512-289">也就是說，即使仍有某些產品`CategoryID`s 已變更合法的值，並更新資料庫中，已將交易回復時發生外部索引鍵條件約束違規。</span><span class="sxs-lookup"><span data-stu-id="eb512-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="eb512-290">現在請按一下 [修改類別 （不含交易）] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="eb512-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="eb512-291">這會導致相同的 foreign key 條件約束違規錯誤 （請參閱圖 9），但這次這些產品的`CategoryID`值已變更為合法值將不會回復。</span><span class="sxs-lookup"><span data-stu-id="eb512-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="eb512-292">叫用瀏覽器 s 上一頁 按鈕，然後重新整理格線 按鈕。</span><span class="sxs-lookup"><span data-stu-id="eb512-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="eb512-293">如圖 10 所示，`CategoryID`前八個產品之已重新指派。</span><span class="sxs-lookup"><span data-stu-id="eb512-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="eb512-294">例如，在圖 8 中，變更必須`CategoryID`為 1，但在圖 10 it s 已重新指派為 2。</span><span class="sxs-lookup"><span data-stu-id="eb512-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="eb512-295">[![某些產品 CategoryID 值未更新時其他人已](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="eb512-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span></span>

<span data-ttu-id="eb512-296">**圖 10**： 某些產品`CategoryID`值未更新時其他人已 ([按一下以檢視完整大小的影像](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="eb512-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="eb512-297">總結</span><span class="sxs-lookup"><span data-stu-id="eb512-297">Summary</span></span>

<span data-ttu-id="eb512-298">根據預設，TableAdapter 的方法不會換行的資料庫執行陳述式，在交易範圍內，但是我們可以輕鬆地加入方法，以建立、 認可和回復交易。</span><span class="sxs-lookup"><span data-stu-id="eb512-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="eb512-299">在本教學課程中，我們建立三個這類方法中的`ProductsTableAdapter`類別： `BeginTransaction`， `CommitTransaction`，和`RollbackTransaction`。</span><span class="sxs-lookup"><span data-stu-id="eb512-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="eb512-300">我們了解如何使用這些方法，連同`Try...Catch`進行一系列的資料修改陳述式不可部分完成的區塊。</span><span class="sxs-lookup"><span data-stu-id="eb512-300">We saw how to use these methods along with a `Try...Catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="eb512-301">特別是，我們建立`UpdateWithTransaction`方法中的`ProductsTableAdapter`，其用於執行必要的修改提供的資料列批次更新模式`ProductsDataTable`。</span><span class="sxs-lookup"><span data-stu-id="eb512-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="eb512-302">我們也加入`DeleteProductsWithTransaction`方法`ProductsBLL`類別中，可接受 BLL`List`的`ProductID`值做為其輸入，並呼叫 DB Direct 模式方法`Delete`每個`ProductID`。</span><span class="sxs-lookup"><span data-stu-id="eb512-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="eb512-303">這兩種方法啟動所建立的交易，並執行資料修改陳述式內`Try...Catch`區塊。</span><span class="sxs-lookup"><span data-stu-id="eb512-303">Both methods start by creating a transaction and then executing the data modification statements within a `Try...Catch` block.</span></span> <span data-ttu-id="eb512-304">如果發生例外狀況，交易回復，否則便被認可。</span><span class="sxs-lookup"><span data-stu-id="eb512-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="eb512-305">步驟 5 所述的效果與帶走使用交易的批次更新的交易式批次更新。</span><span class="sxs-lookup"><span data-stu-id="eb512-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="eb512-306">接下來三個教學課程中我們會配置在本教學課程的基礎建置，以及建立使用者介面，執行批次更新、 刪除及插入。</span><span class="sxs-lookup"><span data-stu-id="eb512-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="eb512-307">祝您程式設計 ！</span><span class="sxs-lookup"><span data-stu-id="eb512-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="eb512-308">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="eb512-308">Further Reading</span></span>

<span data-ttu-id="eb512-309">如需有關在本教學課程所討論的主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="eb512-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="eb512-310">維護資料庫與交易的一致性</span><span class="sxs-lookup"><span data-stu-id="eb512-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="eb512-311">管理 SQL Server 中的交易預存程序</span><span class="sxs-lookup"><span data-stu-id="eb512-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="eb512-312">交易更容易： `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="eb512-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="eb512-313">TransactionScope 和 Dataadapter</span><span class="sxs-lookup"><span data-stu-id="eb512-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="eb512-314">在.NET 中使用 Oracle 資料庫交易</span><span class="sxs-lookup"><span data-stu-id="eb512-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="eb512-315">關於作者</span><span class="sxs-lookup"><span data-stu-id="eb512-315">About the Author</span></span>

<span data-ttu-id="eb512-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七個 ASP/ASP.NET 書籍和的創辦[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已從 1998 年使用 Microsoft Web 技術。</span><span class="sxs-lookup"><span data-stu-id="eb512-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="eb512-317">Scott 可做為獨立顧問、 訓練和寫入器。</span><span class="sxs-lookup"><span data-stu-id="eb512-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="eb512-318">他最新的活頁簿[ *Sam 教導您自己 ASP.NET 2.0 24 小時內*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="eb512-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="eb512-319">他可以在達到[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)或透過他的部落格，這可以在找到[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="eb512-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="eb512-320">特別感謝</span><span class="sxs-lookup"><span data-stu-id="eb512-320">Special Thanks To</span></span>

<span data-ttu-id="eb512-321">許多有用的檢閱者已檢閱本教學課程系列。</span><span class="sxs-lookup"><span data-stu-id="eb512-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="eb512-322">此教學課程中的前導檢閱者已 Dave Gardner、 Hilton Giesenow 和本文菲。</span><span class="sxs-lookup"><span data-stu-id="eb512-322">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="eb512-323">檢閱我即將推出的 MSDN 文件有興趣嗎？</span><span class="sxs-lookup"><span data-stu-id="eb512-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="eb512-324">如果是這樣，卸除我一行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="eb512-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="eb512-325">[上一頁](batch-inserting-cs.md)
> [下一頁](batch-updating-vb.md)</span><span class="sxs-lookup"><span data-stu-id="eb512-325">[Previous](batch-inserting-cs.md)
[Next](batch-updating-vb.md)</span></span>
