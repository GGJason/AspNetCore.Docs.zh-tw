---
title: 從 ASP.NET Core 3.1 遷移至5。0
author: scottaddie
description: 瞭解如何將 ASP.NET Core 3.1 專案遷移至 ASP.NET Core 5.0。
ms.author: scaddie
ms.custom: mvc
ms.date: 11/18/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: migration/31-to-50
ms.openlocfilehash: 22dba2cbb83244d6ac89d61cf09b9019fbe5ca8d
ms.sourcegitcommit: df808efa68574dd674f1985aa9d03f4f5fab883f
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/18/2020
ms.locfileid: "94851191"
---
# <a name="migrate-from-aspnet-core-31-to-50"></a><span data-ttu-id="815b9-103">從 ASP.NET Core 3.1 遷移至5。0</span><span class="sxs-lookup"><span data-stu-id="815b9-103">Migrate from ASP.NET Core 3.1 to 5.0</span></span>

<span data-ttu-id="815b9-104">作者：[Scott Addie](https://github.com/scottaddie)</span><span class="sxs-lookup"><span data-stu-id="815b9-104">By [Scott Addie](https://github.com/scottaddie)</span></span>

<span data-ttu-id="815b9-105">本文說明如何將現有的 ASP.NET Core 3.1 專案更新為 ASP.NET Core 5.0。</span><span class="sxs-lookup"><span data-stu-id="815b9-105">This article explains how to update an existing ASP.NET Core 3.1 project to ASP.NET Core 5.0.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="815b9-106">必要條件</span><span class="sxs-lookup"><span data-stu-id="815b9-106">Prerequisites</span></span>

# <a name="visual-studio"></a>[<span data-ttu-id="815b9-107">Visual Studio</span><span class="sxs-lookup"><span data-stu-id="815b9-107">Visual Studio</span></span>](#tab/visual-studio)

[!INCLUDE[](~/includes/net-core-prereqs-vs-5.0.md)]

# <a name="visual-studio-code"></a>[<span data-ttu-id="815b9-108">Visual Studio Code</span><span class="sxs-lookup"><span data-stu-id="815b9-108">Visual Studio Code</span></span>](#tab/visual-studio-code)

[!INCLUDE[](~/includes/net-core-prereqs-vsc-5.0.md)]

# <a name="visual-studio-for-mac"></a>[<span data-ttu-id="815b9-109">Visual Studio for Mac</span><span class="sxs-lookup"><span data-stu-id="815b9-109">Visual Studio for Mac</span></span>](#tab/visual-studio-mac)

[!INCLUDE[](~/includes/net-core-prereqs-mac-5.0.md)]

---

## <a name="update-net-core-sdk-version-in-globaljson"></a><span data-ttu-id="815b9-110">更新 global.json 中的 .NET Core SDK 版本</span><span class="sxs-lookup"><span data-stu-id="815b9-110">Update .NET Core SDK version in global.json</span></span>

<span data-ttu-id="815b9-111">如果您依賴檔案 [ 上的global.js](/dotnet/core/tools/global-json) ，以特定的 .NET Core SDK 版本為目標，請將該 `version` 屬性更新為已安裝的 .net 5.0 SDK 版本。</span><span class="sxs-lookup"><span data-stu-id="815b9-111">If you rely upon a [global.json](/dotnet/core/tools/global-json) file to target a specific .NET Core SDK version, update the `version` property to the .NET 5.0 SDK version that's installed.</span></span> <span data-ttu-id="815b9-112">例如：</span><span class="sxs-lookup"><span data-stu-id="815b9-112">For example:</span></span>

```diff
{
  "sdk": {
-    "version": "3.1.200"
+    "version": "5.0.100"
  }
}
```

## <a name="update-the-target-framework"></a><span data-ttu-id="815b9-113">更新目標 framework</span><span class="sxs-lookup"><span data-stu-id="815b9-113">Update the target framework</span></span>

<span data-ttu-id="815b9-114">如果更新 Blazor WebAssembly 專案，請跳至 [更新 Blazor WebAssembly 專案](#update-blazor-webassembly-projects) 一節。</span><span class="sxs-lookup"><span data-stu-id="815b9-114">If updating a Blazor WebAssembly project, skip to the [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) section.</span></span> <span data-ttu-id="815b9-115">若為任何其他 ASP.NET Core 專案類型，請將專案檔的 [目標 Framework 標記 (TFM) ](/dotnet/standard/frameworks) 更新為 `net5.0` ：</span><span class="sxs-lookup"><span data-stu-id="815b9-115">For any other ASP.NET Core project type, update the project file's [Target Framework Moniker (TFM)](/dotnet/standard/frameworks) to `net5.0`:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
  </PropertyGroup>

</Project>
```

## <a name="update-no-locblazor-webassembly-and-no-locblazor-server-projects"></a><span data-ttu-id="815b9-116">更新 Blazor WebAssembly 和 Blazor Server 專案</span><span class="sxs-lookup"><span data-stu-id="815b9-116">Update Blazor WebAssembly and Blazor Server projects</span></span>

<span data-ttu-id="815b9-117">*本節中的指導方針適用于這兩個 Blazor 裝載模型。本節後面的各節提供裝載模型和應用程式類型的其他相關指引。將所有相關區段中的 guidnace 套用至您的應用程式。*</span><span class="sxs-lookup"><span data-stu-id="815b9-117">*The guidance in this section applies to both Blazor hosting models. Sections following this section provide additional guidance specific to hosting models and app types. Apply the guidnace from all relevant sections to your app.*</span></span>

1. <span data-ttu-id="815b9-118">在應用程式 `wwwroot/index.html` Blazor WebAssembly 或 `Pages/_Host.cshtml` 應用程式的中 Blazor Server ，將專案加入 `<link>` 至樣式的 `<head>` 元素中。</span><span class="sxs-lookup"><span data-stu-id="815b9-118">In `wwwroot/index.html` of a Blazor WebAssembly app or the `Pages/_Host.cshtml` of a Blazor Server app, add a `<link>` element to the `<head>` element for styles.</span></span> <span data-ttu-id="815b9-119">在下列 `<link>` 元素 `href` 屬性值中，預留位置 `{ASSEMBLY NAME}` 是應用程式的元件名稱。</span><span class="sxs-lookup"><span data-stu-id="815b9-119">In the following `<link>` element `href` attribute values, the placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

    ```diff
    +<link href="{ASSEMBLY NAME}.styles.css" rel="stylesheet" />
    ```
    
    <span data-ttu-id="815b9-120">獨立 Blazor WebAssembly 或 Blazor Server 範例：</span><span class="sxs-lookup"><span data-stu-id="815b9-120">Standalone Blazor WebAssembly or Blazor Server example:</span></span>
    
    ```diff
    +<link href="BlazorSample.styles.css" rel="stylesheet" />
    ```

    <span data-ttu-id="815b9-121">*`Client`* 託管 Blazor WebAssembly 解決方案範例的專案：</span><span class="sxs-lookup"><span data-stu-id="815b9-121">*`Client`* project of a hosted Blazor WebAssembly solution example:</span></span>
    
    ```diff
    +<link href="BlazorSample.Client.styles.css" rel="stylesheet" />
    ```

1. <span data-ttu-id="815b9-122">在 `_Imports.razor` [元件虛擬化](xref:blazor/components/virtualization)的應用程式檔案中包含新的命名空間 <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName> 。</span><span class="sxs-lookup"><span data-stu-id="815b9-122">Include a new namespace in the app's `_Imports.razor` file for [component virtualization](xref:blazor/components/virtualization), <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName>.</span></span> <span data-ttu-id="815b9-123">下列檔案 `_Imports.razor` 顯示專案範本所產生之應用程式中的預設命名空間 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="815b9-123">The following `_Imports.razor` files show the default namespaces in apps generated from the Blazor project templates.</span></span> <span data-ttu-id="815b9-124">預留位置 `{ASSEMBLY NAME}` 是應用程式的元件名稱。</span><span class="sxs-lookup"><span data-stu-id="815b9-124">The placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

   <span data-ttu-id="815b9-125">Blazor WebAssembly (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="815b9-125">Blazor WebAssembly (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using System.Net.Http.Json
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.AspNetCore.Components.WebAssembly.Http
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```

   <span data-ttu-id="815b9-126">Blazor Server (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="815b9-126">Blazor Server (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using Microsoft.AspNetCore.Authorization
   @using Microsoft.AspNetCore.Components.Authorization
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```
   
1. <span data-ttu-id="815b9-127">在 `MainLayout` 元件 (`Shared/MainLayout.razor`) 中，使用 `<div>` `class` 屬性設定為的專案，括住元件的 HTML 標籤 `page` ：</span><span class="sxs-lookup"><span data-stu-id="815b9-127">In the `MainLayout` component (`Shared/MainLayout.razor`), surround the component's HTML markup with a `<div>` element that has a `class` attribute set to `page`:</span></span>

    ```razor
    <div class="page">
    
        ...
        
    </div>
    ```
    
1. <span data-ttu-id="815b9-128">將下列檔案新增至 `Shared` 資料夾：</span><span class="sxs-lookup"><span data-stu-id="815b9-128">Add the following files to the `Shared` folder:</span></span>

    <span data-ttu-id="815b9-129">`MainLayout.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="815b9-129">`MainLayout.razor.css`:</span></span>
    
    ```css
    .page {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .main {
        flex: 1;
    }

    .sidebar {
        background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
    }

    .top-row {
        background-color: #f7f7f7;
        border-bottom: 1px solid #d6d5d5;
        justify-content: flex-end;
        height: 3.5rem;
        display: flex;
        align-items: center;
    }

        .top-row ::deep a, .top-row .btn-link {
            white-space: nowrap;
            margin-left: 1.5rem;
        }

        .top-row a:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
        }

    @media (max-width: 767.98px) {
        .top-row:not(.auth) {
            display: none;
        }

        .top-row.auth {
            justify-content: space-between;
        }

        .top-row a, .top-row .btn-link {
            margin-left: 0;
        }
    }

    @media (min-width: 768px) {
        .page {
            flex-direction: row;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .top-row {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .main > div {
            padding-left: 2rem !important;
            padding-right: 1.5rem !important;
        }
    }
    ```
    
    <span data-ttu-id="815b9-130">`NavMenu.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="815b9-130">`NavMenu.razor.css`:</span></span>
    
    ```css
    .navbar-toggler {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .top-row {
        height: 3.5rem;
        background-color: rgba(0,0,0,0.4);
    }

    .navbar-brand {
        font-size: 1.1rem;
    }

    .oi {
        width: 2rem;
        font-size: 1.1rem;
        vertical-align: text-top;
        top: -2px;
    }

    .nav-item {
        font-size: 0.9rem;
        padding-bottom: 0.5rem;
    }

        .nav-item:first-of-type {
            padding-top: 1rem;
        }

        .nav-item:last-of-type {
            padding-bottom: 1rem;
        }

        .nav-item ::deep a {
            color: #d7d7d7;
            border-radius: 4px;
            height: 3rem;
            display: flex;
            align-items: center;
            line-height: 3rem;
        }

    .nav-item ::deep a.active {
        background-color: rgba(255,255,255,0.25);
        color: white;
    }

    .nav-item ::deep a:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
    }

    @media (min-width: 768px) {
        .navbar-toggler {
            display: none;
        }

        .collapse {
            /* Never collapse the sidebar for wide screens */
            display: block;
        }
    }
    ```

1. <span data-ttu-id="815b9-131">應用程式或應用程式檔案的最新基底檔案 `wwwroot/css/app.css` Blazor WebAssembly `wwwroot/css/site.css` Blazor Server 包含下列樣式。</span><span class="sxs-lookup"><span data-stu-id="815b9-131">The latest base `wwwroot/css/app.css` file of a Blazor WebAssembly app or `wwwroot/css/site.css` file of a Blazor Server app includes the following styles.</span></span> <span data-ttu-id="815b9-132">移除額外的樣式，並保留下列樣式以及您已新增至應用程式的任何樣式。</span><span class="sxs-lookup"><span data-stu-id="815b9-132">Remove extra styles leaving the following styles and any that you've added to the app.</span></span>

    <span data-ttu-id="815b9-133">下列樣式表單只包含基底樣式，而且 **不包含開發** 人員新增的自訂樣式：</span><span class="sxs-lookup"><span data-stu-id="815b9-133">The following stylesheet only includes base styles and does **not** include custom styles added by the developer:</span></span>
   
    ```css
    @import url('open-iconic/font/css/open-iconic-bootstrap.min.css');

    html, body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    a, .btn-link {
        color: #0366d6;
    }

    .btn-primary {
        color: #fff;
        background-color: #1b6ec2;
        border-color: #1861ac;
    }

    .content {
        padding-top: 1.1rem;
    }

    .valid.modified:not([type=checkbox]) {
        outline: 1px solid #26b050;
    }

    .invalid {
        outline: 1px solid red;
    }

    .validation-message {
        color: red;
    }

    #blazor-error-ui {
        background: lightyellow;
        bottom: 0;
        box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        left: 0;
        padding: 0.6rem 1.25rem 0.7rem 1.25rem;
        position: fixed;
        width: 100%;
        z-index: 1000;
    }

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
    ```

## <a name="update-no-locblazor-webassembly-projects"></a><span data-ttu-id="815b9-134">更新 Blazor WebAssembly 專案</span><span class="sxs-lookup"><span data-stu-id="815b9-134">Update Blazor WebAssembly projects</span></span>

<span data-ttu-id="815b9-135">針對 Blazor WebAssembly 專案（包括 *`Client`* 主控方案的專案 Blazor ），將下列變更套用至專案檔：</span><span class="sxs-lookup"><span data-stu-id="815b9-135">For a Blazor WebAssembly project, including the *`Client`* project of a hosted Blazor solution, apply the following changes to the project file:</span></span>

1. <span data-ttu-id="815b9-136">將 SDK 從更新 `Microsoft.NET.Sdk.Web` 為 `Microsoft.NET.Sdk.BlazorWebAssembly` ：</span><span class="sxs-lookup"><span data-stu-id="815b9-136">Update the SDK from `Microsoft.NET.Sdk.Web` to `Microsoft.NET.Sdk.BlazorWebAssembly`:</span></span>

    ```diff
    - <Project Sdk="Microsoft.NET.Sdk.Web">
    + <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    ```
    
    > [!NOTE]
    > <span data-ttu-id="815b9-137">此更新僅適用于獨立 Blazor WebAssembly 專案和裝載 *`Client`* 解決方案的專案 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="815b9-137">This update only applies to standalone Blazor WebAssembly projects and the *`Client`* projects of hosted Blazor solutions.</span></span>

1. <span data-ttu-id="815b9-138">更新下列屬性：</span><span class="sxs-lookup"><span data-stu-id="815b9-138">Update the following properties:</span></span>

    ```diff
    <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    
      <PropertyGroup>
    -     <TargetFramework>netstandard2.1</TargetFramework>
    -     <RazorLangVersion>3.0</RazorLangVersion>
    +     <TargetFramework>net5.0</TargetFramework>
      </PropertyGroup>
    ```

1. <span data-ttu-id="815b9-139">移除 WebAssembly 的套件參考。 [建立 AspNetCore](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build)：</span><span class="sxs-lookup"><span data-stu-id="815b9-139">Remove the package reference to [Microsoft.AspNetCore.Components.WebAssembly.Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span></span>

    ```diff
    <ItemGroup>
    -    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Build" Version="3.2.1" PrivateAssets="all" />
    ```

1. <span data-ttu-id="815b9-140">將其他套件更新至其最新版本。</span><span class="sxs-lookup"><span data-stu-id="815b9-140">Update other packages to their latest versions.</span></span> <span data-ttu-id="815b9-141">您可以在 [NuGet.org](https://www.nuget.org)找到最新版本。</span><span class="sxs-lookup"><span data-stu-id="815b9-141">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

1. <span data-ttu-id="815b9-142">在中 `wwwroot/index.html` ，將載入元件的元素變更為專案， `App` `<div>` 其 `id` 設定為 `app` ：</span><span class="sxs-lookup"><span data-stu-id="815b9-142">In `wwwroot/index.html`, change the element that loads the `App` component to a `<div>` element with an `id` set to `app`:</span></span>
    
    ```diff
    -<app>Loading...</app>
    +<div id="app">Loading...</div>
    ```
    
1. <span data-ttu-id="815b9-143">在 `Program.Main` (`Program.cs`) ：</span><span class="sxs-lookup"><span data-stu-id="815b9-143">In `Program.Main` (`Program.cs`):</span></span>

   * <span data-ttu-id="815b9-144">藉 `<app>` 由在其中加入雜湊，將元素的參考變更為 CSS 選取器 `#` 。</span><span class="sxs-lookup"><span data-stu-id="815b9-144">Change the reference to the `<app>` element to a CSS selector by adding a hash `#` to it.</span></span>
   * <span data-ttu-id="815b9-145">將 `HttpClient` 註冊變更為限域。</span><span class="sxs-lookup"><span data-stu-id="815b9-145">Change the `HttpClient` registration to scoped.</span></span>

    ```diff
    -builder.RootComponents.Add<App>("app");
    +builder.RootComponents.Add<App>("#app");
    
    -builder.Services.AddTransient(sp => new HttpClient 
    -    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    +builder.Services.AddScoped(sp => new HttpClient 
    +    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    ```

### <a name="standalone-no-locblazor-webassembly-app-with-microsoft-accounts"></a><span data-ttu-id="815b9-146">Blazor WebAssembly使用 Microsoft 帳戶的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="815b9-146">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>

<span data-ttu-id="815b9-147">針對 Blazor WebAssembly 在 Azure 入口網站中註冊的獨立應用程式，以使用適用于 Microsoft 帳戶的 Azure Active Directory (AAD) ：</span><span class="sxs-lookup"><span data-stu-id="815b9-147">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) for Microsoft Accounts:</span></span>

* <span data-ttu-id="815b9-148">應用程式需要 `openid` 和 `offline_access` 範圍：</span><span class="sxs-lookup"><span data-stu-id="815b9-148">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="815b9-149">在 Azure 入口網站應用程式註冊 **驗證** ] 分頁中，使用應用程式的重新導向 URI 將平臺設定設定為 **單一頁面應用程式** 。</span><span class="sxs-lookup"><span data-stu-id="815b9-149">In the Azure portal app registration **Authentication** blade, set the platform configuration to **Single-page application** with the app's redirect URI.</span></span>

* <span data-ttu-id="815b9-150">此外，在 **[驗證**] 分頁中，停 **用存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="815b9-150">Also in the **Authentication** blade, disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="815b9-151">如需詳細資訊，請參閱<xref:blazor/security/webassembly/standalone-with-microsoft-accounts>。</span><span class="sxs-lookup"><span data-stu-id="815b9-151">For more information, see <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span></span>

### <a name="standalone-no-locblazor-webassembly-app-with-azure-active-directory-aad"></a><span data-ttu-id="815b9-152">Blazor WebAssembly具有 Azure Active Directory (AAD) 的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="815b9-152">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>

<span data-ttu-id="815b9-153">針對 Blazor WebAssembly 在 Azure 入口網站中註冊的獨立應用程式，以使用 Azure Active Directory (AAD) ：</span><span class="sxs-lookup"><span data-stu-id="815b9-153">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD):</span></span>

* <span data-ttu-id="815b9-154">應用程式需要 `https://graph.microsoft.com/User.Read` 範圍：</span><span class="sxs-lookup"><span data-stu-id="815b9-154">The app requires the `https://graph.microsoft.com/User.Read` scope:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes
      .Add("https://graph.microsoft.com/User.Read");
  ```
  
* <span data-ttu-id="815b9-155">在 Azure 入口網站應用程式註冊 **驗證** ] 分頁中，使用應用程式的重新導向 URI 將平臺設定設定為 **單一頁面應用程式** 。</span><span class="sxs-lookup"><span data-stu-id="815b9-155">In the Azure portal app registration **Authentication** blade, set the platform configuration to **Single-page application** with the app's redirect URI.</span></span>

* <span data-ttu-id="815b9-156">此外，在 **[驗證**] 分頁中，停 **用存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="815b9-156">Also in the **Authentication** blade, disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>
  
<span data-ttu-id="815b9-157">如需詳細資訊，請參閱<xref:blazor/security/webassembly/standalone-with-azure-active-directory>。</span><span class="sxs-lookup"><span data-stu-id="815b9-157">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span></span>

### <a name="standalone-no-locblazor-app-with-azure-active-directory-aad-b2c"></a><span data-ttu-id="815b9-158">Blazor使用 Azure Active Directory (AAD) B2C 的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="815b9-158">Standalone Blazor app with Azure Active Directory (AAD) B2C</span></span>

<span data-ttu-id="815b9-159">針對 Blazor WebAssembly 在 Azure 入口網站中註冊的獨立應用程式，以使用 Azure Active Directory (AAD) B2C：</span><span class="sxs-lookup"><span data-stu-id="815b9-159">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) B2C:</span></span>

* <span data-ttu-id="815b9-160">應用程式需要 `openid` 和 `offline_access` 範圍：</span><span class="sxs-lookup"><span data-stu-id="815b9-160">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="815b9-161">在 Azure 入口網站應用程式註冊 **驗證** ] 分頁中，使用應用程式的重新導向 URI 將平臺設定設定為 **單一頁面應用程式** 。</span><span class="sxs-lookup"><span data-stu-id="815b9-161">In the Azure portal app registration **Authentication** blade, set the platform configuration to **Single-page application** with the app's redirect URI.</span></span>

* <span data-ttu-id="815b9-162">此外，在 **[驗證**] 分頁中，停 **用存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="815b9-162">Also in the **Authentication** blade, disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="815b9-163">如需詳細資訊，請參閱<xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>。</span><span class="sxs-lookup"><span data-stu-id="815b9-163">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span></span>

### <a name="hosted-no-locblazor-webassembly-app-with-azure-active-directory-aad-or-b2c"></a><span data-ttu-id="815b9-164">Blazor WebAssembly具有 Azure Active Directory (AAD) 或 B2C 的託管應用程式</span><span class="sxs-lookup"><span data-stu-id="815b9-164">Hosted Blazor WebAssembly app with Azure Active Directory (AAD) or B2C</span></span>

<span data-ttu-id="815b9-165">*`Client`* Blazor 使用 AAD 或 AAD B2C 進行使用者驗證之託管解決方案的應用程式註冊，應使用 **單一頁面應用程式** Azure 應用程式平臺設定：</span><span class="sxs-lookup"><span data-stu-id="815b9-165">The *`Client`* app registration of a hosted Blazor solution that uses AAD or AAD B2C for user authentication should use a **Single-page application** Azure Apps platform configuration:</span></span>

1. <span data-ttu-id="815b9-166">在應用程式的 Azure 入口網站應用程式註冊中 *`Client`* ，移除 **Web** platform configuration。</span><span class="sxs-lookup"><span data-stu-id="815b9-166">In the Azure portal app registration for the *`Client`* app, remove the **Web** platform configuration.</span></span>
1. <span data-ttu-id="815b9-167">使用應用程式的重新導向 URI 新增 **單一頁面應用程式** 平臺設定。</span><span class="sxs-lookup"><span data-stu-id="815b9-167">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
1. <span data-ttu-id="815b9-168">停用 **存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="815b9-168">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="815b9-169">如需詳細資訊，請參閱</span><span class="sxs-lookup"><span data-stu-id="815b9-169">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="update-the-server-project-of-a-hosted-no-locblazor-solution"></a><span data-ttu-id="815b9-170">更新主控方案的伺服器專案 Blazor</span><span class="sxs-lookup"><span data-stu-id="815b9-170">Update the Server project of a hosted Blazor solution</span></span>

<span data-ttu-id="815b9-171">遵循本文 *`Server`* 中的一般指引，將託管解決方案的專案更新 Blazor 為 ASP.NET Core 應用程式。</span><span class="sxs-lookup"><span data-stu-id="815b9-171">Update the *`Server`* project of a hosted Blazor solution as an ASP.NET Core app following the general guidance in this article.</span></span>

<span data-ttu-id="815b9-172">此外， *`Server`* Blazor WebAssembly 使用 AZURE ACTIVE DIRECTORY (AAD) 或 B2C 向用戶端應用程式驗證使用者的專案應該採用新的 Microsoft v2.0 Identity 套件：</span><span class="sxs-lookup"><span data-stu-id="815b9-172">Additionally, *`Server`* projects that authenticate users to client Blazor WebAssembly apps with Azure Active Directory (AAD) or B2C should adopt new Microsoft Identity v2.0 packages:</span></span> 
  
<span data-ttu-id="815b9-173">針對 AAD：</span><span class="sxs-lookup"><span data-stu-id="815b9-173">For AAD:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureAD.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="815b9-174">針對 AAD B2C：</span><span class="sxs-lookup"><span data-stu-id="815b9-174">For AAD B2C:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureADB2C.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="815b9-175">針對上述的套件參考，請 `{VERSION}` 在 NuGet.org 上判斷預留位置的套件版本：</span><span class="sxs-lookup"><span data-stu-id="815b9-175">For the preceding package references, determine the package versions for the `{VERSION}` placeholders at NuGet.org:</span></span>

* [`Microsoft.Identity.Web`](https://www.nuget.org/packages/Microsoft.Identity.Web)
* [`Microsoft.Identity.Web.UI`](https://www.nuget.org/packages/Microsoft.Identity.Web.UI)

> [!NOTE]
> <span data-ttu-id="815b9-176">裝載 *`Server`* 解決方案中專案的 SDK 會 Blazor WebAssembly 保持 `Microsoft.NET.Sdk.Web` ：</span><span class="sxs-lookup"><span data-stu-id="815b9-176">The SDK of the *`Server`* project in a hosted Blazor WebAssembly solution remains `Microsoft.NET.Sdk.Web`:</span></span>
>
> ```xml
> <Project Sdk="Microsoft.NET.Sdk.Web">
> ```

<span data-ttu-id="815b9-177">如需詳細資訊，請參閱</span><span class="sxs-lookup"><span data-stu-id="815b9-177">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="unauthorized-client-for-azure-active-directory-aad"></a><span data-ttu-id="815b9-178">Azure Active Directory (AAD) 的未經授權用戶端</span><span class="sxs-lookup"><span data-stu-id="815b9-178">Unauthorized client for Azure Active Directory (AAD)</span></span>

<span data-ttu-id="815b9-179">升級 Blazor WebAssembly 使用 aad 進行驗證的應用程式之後，您可能會在使用者使用 aad 登入後，在登入回呼上收到下列錯誤：</span><span class="sxs-lookup"><span data-stu-id="815b9-179">After upgrading a Blazor WebAssembly app that uses AAD for authentication, you may receive the following error on the login callback to the app after the user signs in with AAD:</span></span>

> <span data-ttu-id="815b9-180">資訊： AspNetCore。 DefaultAuthorizationService [2] 授權失敗。</span><span class="sxs-lookup"><span data-stu-id="815b9-180">info: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2] Authorization failed.</span></span> <span data-ttu-id="815b9-181">不符合這些需求： DenyAnonymousAuthorizationRequirement：需要經過驗證的使用者。</span><span class="sxs-lookup"><span data-stu-id="815b9-181">These requirements were not met: DenyAnonymousAuthorizationRequirement: Requires an authenticated user.</span></span>

<span data-ttu-id="815b9-182">來自 AAD 的登入回呼錯誤：</span><span class="sxs-lookup"><span data-stu-id="815b9-182">Login callback error from AAD:</span></span>

* <span data-ttu-id="815b9-183">錯誤：`unauthorized_client`</span><span class="sxs-lookup"><span data-stu-id="815b9-183">Error: `unauthorized_client`</span></span>
* <span data-ttu-id="815b9-184">說明：`AADB2C90058: The provided application is not configured to allow public clients.`</span><span class="sxs-lookup"><span data-stu-id="815b9-184">Description: `AADB2C90058: The provided application is not configured to allow public clients.`</span></span>

<span data-ttu-id="815b9-185">若要解決此錯誤：</span><span class="sxs-lookup"><span data-stu-id="815b9-185">To resolve the error:</span></span>

1. <span data-ttu-id="815b9-186">在 Azure 入口網站中，存取 [應用程式的資訊清單](/azure/active-directory/develop/reference-app-manifest)。</span><span class="sxs-lookup"><span data-stu-id="815b9-186">In the Azure portal, access the [app's manifest](/azure/active-directory/develop/reference-app-manifest).</span></span>
1. <span data-ttu-id="815b9-187">將 [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) 屬性設為 `null` 或 `true` 。</span><span class="sxs-lookup"><span data-stu-id="815b9-187">Set the [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) attribute to `null` or `true`.</span></span>

## <a name="update-no-locrazor-class-libraries-rcls"></a><span data-ttu-id="815b9-188">更新 Razor 類別庫 (RCLs) </span><span class="sxs-lookup"><span data-stu-id="815b9-188">Update Razor class libraries (RCLs)</span></span>

<span data-ttu-id="815b9-189">Razor (RCLs) 遷移類別庫，以利用 ASP.NET Core 5.0 中引進的新 api 或功能。</span><span class="sxs-lookup"><span data-stu-id="815b9-189">Migrate Razor class libraries (RCLs) to take advantage of new APIs or features that are introduced as part of ASP.NET Core 5.0.</span></span> 

<span data-ttu-id="815b9-190">更新以元件為目標的 RCL：</span><span class="sxs-lookup"><span data-stu-id="815b9-190">To update a RCL that targets components:</span></span>

1. <span data-ttu-id="815b9-191">更新專案檔中的下列屬性：</span><span class="sxs-lookup"><span data-stu-id="815b9-191">Update the following properties in the project file:</span></span>

   ```diff
   <Project Sdk="Microsoft.NET.Sdk.Razor">
    
     <PropertyGroup>
   -     <TargetFramework>netstandard2.0</TargetFramework>
   -     <RazorLangVersion>3.0</RazorLangVersion>
   +     <TargetFramework>net5.0</TargetFramework>
     </PropertyGroup>
   ```

1. <span data-ttu-id="815b9-192">將其他套件更新至其最新版本。</span><span class="sxs-lookup"><span data-stu-id="815b9-192">Update other packages to their latest versions.</span></span> <span data-ttu-id="815b9-193">您可以在 [NuGet.org](https://www.nuget.org)找到最新版本。</span><span class="sxs-lookup"><span data-stu-id="815b9-193">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

<span data-ttu-id="815b9-194">若要更新以 MVC 為目標的 RCL，請更新專案檔中的下列屬性：</span><span class="sxs-lookup"><span data-stu-id="815b9-194">To update an RCL targeting MVC, update the following properties in the project file:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Razor">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
    <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
  </PropertyGroup>
```

## <a name="update-package-references"></a><span data-ttu-id="815b9-195">更新套件參考</span><span class="sxs-lookup"><span data-stu-id="815b9-195">Update package references</span></span>

<span data-ttu-id="815b9-196">在專案檔中，更新每個 [AspNetCore. \*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*)、 [microsoft.entityframeworkcore.](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*)\*、 [，然後](https://www.nuget.org/packages?q=Microsoft.Extensions.*)將封裝參考的屬性上的 [System.Net.Http.Js](https://www.nuget.org/packages/System.Net.Http.Json) 更新 `Version` 為5.0.0 或更新版本。</span><span class="sxs-lookup"><span data-stu-id="815b9-196">In the project file, update each [Microsoft.AspNetCore.\*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft.EntityFrameworkCore.\*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft.Extensions.\*](https://www.nuget.org/packages?q=Microsoft.Extensions.*), and [System.Net.Http.Json](https://www.nuget.org/packages/System.Net.Http.Json) package reference's `Version` attribute to 5.0.0 or later.</span></span> <span data-ttu-id="815b9-197">例如：</span><span class="sxs-lookup"><span data-stu-id="815b9-197">For example:</span></span>

```diff
<ItemGroup>
-    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="3.1.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.1.6">
-    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="3.1.6" />
-    <PackageReference Include="System.Net.Http.Json" Version="3.2.1" />
+    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="5.0.0" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.0">
+    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="5.0.0" />
+    <PackageReference Include="System.Net.Http.Json" Version="5.0.0" />
</ItemGroup>
```

## <a name="update-docker-images"></a><span data-ttu-id="815b9-198">更新 Docker 映射</span><span class="sxs-lookup"><span data-stu-id="815b9-198">Update Docker images</span></span>

<span data-ttu-id="815b9-199">若為使用 Docker 的應用程式，請更新您的 *Dockerfile* `FROM` 語句和腳本。</span><span class="sxs-lookup"><span data-stu-id="815b9-199">For apps using Docker, update your *Dockerfile* `FROM` statements and scripts.</span></span> <span data-ttu-id="815b9-200">使用包含 ASP.NET Core 5.0 執行時間的基底映射。</span><span class="sxs-lookup"><span data-stu-id="815b9-200">Use a base image that includes the ASP.NET Core 5.0 runtime.</span></span> <span data-ttu-id="815b9-201">請考慮下列 `docker pull` ASP.NET Core 3.1 和5.0 之間的命令差異：</span><span class="sxs-lookup"><span data-stu-id="815b9-201">Consider the following `docker pull` command difference between ASP.NET Core 3.1 and 5.0:</span></span>

```diff
- docker pull mcr.microsoft.com/dotnet/core/aspnet:3.1
+ docker pull mcr.microsoft.com/dotnet/aspnet:5.0
```

<span data-ttu-id="815b9-202">在移至 ".NET" 作為產品名稱的過程中，會將 Docker 映射從 `mcr.microsoft.com/dotnet/core` 存放庫移至 `mcr.microsoft.com/dotnet` 。</span><span class="sxs-lookup"><span data-stu-id="815b9-202">As part of the move to ".NET" as the product name, the Docker images moved from the `mcr.microsoft.com/dotnet/core` repositories to `mcr.microsoft.com/dotnet`.</span></span> <span data-ttu-id="815b9-203">如需詳細資訊，請參閱 [dotnet/dotnet-docker # 1939](https://github.com/dotnet/dotnet-docker/issues/1939)。</span><span class="sxs-lookup"><span data-stu-id="815b9-203">For more information, see [dotnet/dotnet-docker#1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span></span>

## <a name="model-binding-changes-in-aspnet-core-mvc-and-no-locrazor-pages"></a><span data-ttu-id="815b9-204">ASP.NET Core MVC 和頁面中的模型系結變更 Razor</span><span class="sxs-lookup"><span data-stu-id="815b9-204">Model binding changes in ASP.NET Core MVC and Razor Pages</span></span>

### <a name="datetime-values-are-model-bound-as-utc-times"></a><span data-ttu-id="815b9-205">日期時間值是以 UTC 時間系結的模型</span><span class="sxs-lookup"><span data-stu-id="815b9-205">DateTime values are model bound as UTC times</span></span>

<span data-ttu-id="815b9-206">在 ASP.NET Core 3.1 及更早版本中， `DateTime` 值是以模型系結為本地時間，其中的時區是由伺服器決定。</span><span class="sxs-lookup"><span data-stu-id="815b9-206">In ASP.NET Core 3.1 and earlier, `DateTime` values were model-bound as local time, where the timezone was determined by the server.</span></span> <span data-ttu-id="815b9-207">`DateTime` 從輸入格式系結的值 (JSON) 和 `DateTimeOffset` 值都系結為 UTC 時區。</span><span class="sxs-lookup"><span data-stu-id="815b9-207">`DateTime` values bound from input formatting (JSON) and `DateTimeOffset` values were bound as UTC timezones.</span></span>

<span data-ttu-id="815b9-208">在 ASP.NET Core 5.0 和更新版本中，模型系結會以 UTC 時區一致地系結 `DateTime` 值。</span><span class="sxs-lookup"><span data-stu-id="815b9-208">In ASP.NET Core 5.0 and later, model binding consistently binds `DateTime` values with the UTC timezone.</span></span>

<span data-ttu-id="815b9-209">若要保留先前的行為，請移除 `DateTimeModelBinderProvider` 中的 `Startup.ConfigureServices` ：</span><span class="sxs-lookup"><span data-stu-id="815b9-209">To retain the previous behavior, remove the `DateTimeModelBinderProvider` in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddControllersWithViews(options => 
    options.ModelBinderProviders.RemoveType<DateTimeModelBinderProvider>());
```

### <a name="complexobjectmodelbinderprovider--complexobjectmodelbinder-replace-complextypemodelbinderprovider--complextypemodelbinder"></a><span data-ttu-id="815b9-210">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span><span class="sxs-lookup"><span data-stu-id="815b9-210">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span></span>

<span data-ttu-id="815b9-211">若要加入模型系結 [c # 9 記錄類型](/dotnet/csharp/whats-new/csharp-9#record-types)的支援，則 <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> 為：</span><span class="sxs-lookup"><span data-stu-id="815b9-211">To add support for model binding [C# 9 record types](/dotnet/csharp/whats-new/csharp-9#record-types), the <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> is:</span></span>

* <span data-ttu-id="815b9-212">標注為過時。</span><span class="sxs-lookup"><span data-stu-id="815b9-212">Annotated as obsolete.</span></span>
* <span data-ttu-id="815b9-213">預設不會再註冊。</span><span class="sxs-lookup"><span data-stu-id="815b9-213">No longer registered by default.</span></span>

<span data-ttu-id="815b9-214">相依于存在於集合中的應用程式 `ComplexTypeModelBinderProvider` `ModelBinderProviders` 需要參考新的系結器提供者：</span><span class="sxs-lookup"><span data-stu-id="815b9-214">Apps that rely on the presence of the `ComplexTypeModelBinderProvider` in the `ModelBinderProviders` collection need to reference the new binder provider:</span></span>

```diff
- var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexTypeModelBinderProvider>();
+ var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexObjectModelBinderProvider>();
```

## <a name="review-breaking-changes"></a><span data-ttu-id="815b9-215">檢查重大變更</span><span class="sxs-lookup"><span data-stu-id="815b9-215">Review breaking changes</span></span>

<span data-ttu-id="815b9-216">如需從 .NET Core 3.1 到 .NET 5.0 的重大變更，請參閱 [從版本3.1 遷移至5.0 的重大變更](/dotnet/core/compatibility/3.1-5.0)。</span><span class="sxs-lookup"><span data-stu-id="815b9-216">For breaking changes from .NET Core 3.1 to .NET 5.0, see [Breaking changes for migration from version 3.1 to 5.0](/dotnet/core/compatibility/3.1-5.0).</span></span> <span data-ttu-id="815b9-217">清單中也包含 ASP.NET Core 和 Entity Framework Core。</span><span class="sxs-lookup"><span data-stu-id="815b9-217">ASP.NET Core and Entity Framework Core are also included in the list.</span></span>
