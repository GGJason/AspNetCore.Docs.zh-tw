---
title: ASP.NET Core 中的資料保護金鑰管理和存留期
author: rick-anderson
description: 深入瞭解 ASP.NET Core 中的資料保護金鑰管理和存留期。
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 2f022a4c7519485fe629ce47c27d214c8c27d5bc
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78667962"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="463aa-103">ASP.NET Core 中的資料保護金鑰管理和存留期</span><span class="sxs-lookup"><span data-stu-id="463aa-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="463aa-104">由 [Rick Anderson](https://twitter.com/RickAndMSFT) 提供</span><span class="sxs-lookup"><span data-stu-id="463aa-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="463aa-105">金鑰管理</span><span class="sxs-lookup"><span data-stu-id="463aa-105">Key management</span></span>

<span data-ttu-id="463aa-106">應用程式會嘗試偵測其操作環境，並自行處理金鑰設定。</span><span class="sxs-lookup"><span data-stu-id="463aa-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="463aa-107">如果應用程式裝載于[Azure 應用程式](https://azure.microsoft.com/services/app-service/)中，金鑰會保存至 *%HOME%\ASP.NET\DataProtection-Keys*資料夾。</span><span class="sxs-lookup"><span data-stu-id="463aa-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="463aa-108">此資料夾使用網路儲存體進行保存，並會在裝載應用程式的所有電腦上同步。</span><span class="sxs-lookup"><span data-stu-id="463aa-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="463aa-109">金鑰待用時不受保護。</span><span class="sxs-lookup"><span data-stu-id="463aa-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="463aa-110">[ *DataProtection Keys* ] 資料夾會在單一部署位置中，將金鑰環提供給應用程式的所有實例。</span><span class="sxs-lookup"><span data-stu-id="463aa-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="463aa-111">各部署位置，例如預備和生產位置，不會共用金鑰環。</span><span class="sxs-lookup"><span data-stu-id="463aa-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="463aa-112">當您在部署位置之間交換時（例如交換暫存至生產環境或使用 A/B 測試），任何使用資料保護的應用程式將無法使用先前插槽內的金鑰環來解密儲存的資料。</span><span class="sxs-lookup"><span data-stu-id="463aa-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="463aa-113">這會導致使用者登出使用標準 ASP.NET Core cookie 驗證的應用程式，因為它使用資料保護來保護其 cookie。</span><span class="sxs-lookup"><span data-stu-id="463aa-113">This leads to users being logged out of an app that uses the standard ASP.NET Core cookie authentication, as it uses Data Protection to protect its cookies.</span></span> <span data-ttu-id="463aa-114">如果您想要與位置無關的金鑰環，請使用外部金鑰環形提供者，例如 Azure Blob 儲存體、Azure Key Vault、SQL 存放區或 Redis 快取。</span><span class="sxs-lookup"><span data-stu-id="463aa-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="463aa-115">如果有可用的使用者設定檔，金鑰會保存在 *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys*資料夾中。</span><span class="sxs-lookup"><span data-stu-id="463aa-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="463aa-116">如果作業系統是 Windows，則會使用 DPAPI 在待用時加密金鑰。</span><span class="sxs-lookup"><span data-stu-id="463aa-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

   <span data-ttu-id="463aa-117">應用程式集區的 [setProfileEnvironment 屬性](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration)也必須啟用。</span><span class="sxs-lookup"><span data-stu-id="463aa-117">The app pool's [setProfileEnvironment attribute](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) must also be enabled.</span></span> <span data-ttu-id="463aa-118">`setProfileEnvironment` 的預設值為 `true`。</span><span class="sxs-lookup"><span data-stu-id="463aa-118">The default value of `setProfileEnvironment` is `true`.</span></span> <span data-ttu-id="463aa-119">在某些情況下 (例如 Windows OS)，`setProfileEnvironment` 會設為 `false`。</span><span class="sxs-lookup"><span data-stu-id="463aa-119">In some scenarios (for example, Windows OS), `setProfileEnvironment` is set to `false`.</span></span> <span data-ttu-id="463aa-120">如果金鑰並未如預期地儲存在使用者設定檔目錄中：</span><span class="sxs-lookup"><span data-stu-id="463aa-120">If keys aren't stored in the user profile directory as expected:</span></span>

   1. <span data-ttu-id="463aa-121">瀏覽至 *%windir%/system32/inetsrv/config* 資料夾。</span><span class="sxs-lookup"><span data-stu-id="463aa-121">Navigate to the *%windir%/system32/inetsrv/config* folder.</span></span>
   1. <span data-ttu-id="463aa-122">開啟 *applicationHost.config* 檔案。</span><span class="sxs-lookup"><span data-stu-id="463aa-122">Open the *applicationHost.config* file.</span></span>
   1. <span data-ttu-id="463aa-123">找出 `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` 元素。</span><span class="sxs-lookup"><span data-stu-id="463aa-123">Locate the `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` element.</span></span>
   1. <span data-ttu-id="463aa-124">確認 `setProfileEnvironment` 屬性不存在 (其預設值為 `true`)，或明確地將屬性值設為 `true`。</span><span class="sxs-lookup"><span data-stu-id="463aa-124">Confirm that the `setProfileEnvironment` attribute isn't present, which defaults the value to `true`, or explicitly set the attribute's value to `true`.</span></span>

1. <span data-ttu-id="463aa-125">如果應用程式裝載于 IIS 中，則金鑰會保存到 HKLM 登錄中，只會碰到到背景工作進程帳戶的特殊登錄機碼中。</span><span class="sxs-lookup"><span data-stu-id="463aa-125">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="463aa-126">在待用期間使用 DPAPI 加密金鑰。</span><span class="sxs-lookup"><span data-stu-id="463aa-126">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="463aa-127">如果這些條件都不符合，則索引鍵不會保存在目前的進程之外。</span><span class="sxs-lookup"><span data-stu-id="463aa-127">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="463aa-128">當進程關閉時，所有產生的金鑰都會遺失。</span><span class="sxs-lookup"><span data-stu-id="463aa-128">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="463aa-129">開發人員永遠都是完全控制，而且可以覆寫儲存金鑰的方式和位置。</span><span class="sxs-lookup"><span data-stu-id="463aa-129">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="463aa-130">上述前三個選項應該為大部分應用程式提供良好的預設值，類似于 ASP.NET **\<machineKey >** 自動產生常式在過去的運作方式。</span><span class="sxs-lookup"><span data-stu-id="463aa-130">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="463aa-131">最終的 [回溯] 選項是唯一需要開發[人員指定預先](xref:security/data-protection/configuration/overview)設定的情況（如果他們想要保留金鑰），但只有在罕見的情況下才會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="463aa-131">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="463aa-132">在 Docker 容器中裝載時，金鑰應保存在屬於 Docker 磁片區的資料夾中（共用磁片區或保存在容器存留期以外的主機裝載磁片區），或在外部提供者（例如[Azure Key Vault](https://azure.microsoft.com/services/key-vault/)或[Redis](https://redis.io/)）中。</span><span class="sxs-lookup"><span data-stu-id="463aa-132">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="463aa-133">如果應用程式無法存取共用網路磁片區，則外部提供者也適用于 web 伺服陣列案例（如需詳細資訊，請參閱[PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) ）。</span><span class="sxs-lookup"><span data-stu-id="463aa-133">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="463aa-134">如果開發人員覆寫上面所述的規則，並將資料保護系統指向特定的金鑰存放庫，則會停用待用金鑰的自動加密功能。</span><span class="sxs-lookup"><span data-stu-id="463aa-134">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="463aa-135">待用保護可以透過設定重新[啟用。](xref:security/data-protection/configuration/overview)</span><span class="sxs-lookup"><span data-stu-id="463aa-135">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="463aa-136">金鑰存留期</span><span class="sxs-lookup"><span data-stu-id="463aa-136">Key lifetime</span></span>

<span data-ttu-id="463aa-137">金鑰預設為90天的存留期。</span><span class="sxs-lookup"><span data-stu-id="463aa-137">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="463aa-138">金鑰過期時，應用程式會自動產生新的金鑰，並將新的金鑰設定為作用中金鑰。</span><span class="sxs-lookup"><span data-stu-id="463aa-138">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="463aa-139">只要已淘汰的金鑰保留在系統上，您的應用程式就可以將任何受其保護的資料解密。</span><span class="sxs-lookup"><span data-stu-id="463aa-139">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="463aa-140">如需詳細資訊，請參閱[金鑰管理](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling)。</span><span class="sxs-lookup"><span data-stu-id="463aa-140">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="463aa-141">預設演算法</span><span class="sxs-lookup"><span data-stu-id="463aa-141">Default algorithms</span></span>

<span data-ttu-id="463aa-142">使用的預設承載保護演算法是 AES-256-CBC，適用于機密性和 HMACSHA256 的真實性。</span><span class="sxs-lookup"><span data-stu-id="463aa-142">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="463aa-143">512位主要金鑰（每90天變更）用來針對每個承載，衍生用於這些演算法的兩個子機碼。</span><span class="sxs-lookup"><span data-stu-id="463aa-143">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="463aa-144">如需詳細資訊，請參閱子機碼[衍生](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation)。</span><span class="sxs-lookup"><span data-stu-id="463aa-144">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="463aa-145">其他資源</span><span class="sxs-lookup"><span data-stu-id="463aa-145">Additional resources</span></span>

* <xref:security/data-protection/extensibility/key-management>
* <xref:host-and-deploy/web-farm>
